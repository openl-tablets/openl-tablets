# Refresh Token Flow - –û–±—ä—è—Å–Ω–µ–Ω–∏–µ

## –ß—Ç–æ —Ç–∞–∫–æ–µ Refresh Token Flow?

**Refresh Token Flow** ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ OAuth 2.1, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π —Ç–æ–∫–µ–Ω (`refresh_token`) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ (`access_token`).

## –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–æ–≥–∏—è

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ:
- **Access Token** = –ø—Ä–æ–ø—É—Å–∫ –Ω–∞ –¥–µ–Ω—å (–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 1 —á–∞—Å, –ø–æ—Ç–æ–º –Ω—É–∂–Ω–æ –Ω–æ–≤—ã–π)
- **Refresh Token** = –∫–∞—Ä—Ç–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è (–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –¥–æ–ª–≥–æ, –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–ø—É—Å–∫)

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –í –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```yaml
# compose.yaml
mcp-server:
  environment:
    OPENL_OAUTH2_GRANT_TYPE: refresh_token
    OPENL_OAUTH2_REFRESH_TOKEN: "xgTuyOxzsnmCx2RQirXKX0uGcGqj6lvfZcP.PUmF6M"
    OPENL_OAUTH2_CLIENT_ID: OpenL_Studio
    OPENL_OAUTH2_CLIENT_SECRET: Exigen/2024.02
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ MCP —Å–µ—Ä–≤–µ—Ä–∞:**
   ```
   MCP Server ‚Üí OAuth Provider
   POST /token
   {
     "grant_type": "refresh_token",
     "refresh_token": "xgTuyOxzsnmCx2RQirXKX0uGcGqj6lvfZcP.PUmF6M",
     "client_id": "OpenL_Studio",
     "client_secret": "Exigen/2024.02"
   }
   ```

2. **OAuth Provider –æ—Ç–≤–µ—á–∞–µ—Ç:**
   ```json
   {
     "access_token": "eyJhbGciOiJSUzI1NiIs...",
     "token_type": "Bearer",
     "expires_in": 3600,
     "refresh_token": "xgTuyOxzsnmCx2RQirXKX0uGcGqj6lvfZcP.PUmF6M"
   }
   ```

3. **MCP Server –∏—Å–ø–æ–ª—å–∑—É–µ—Ç access_token:**
   ```
   GET /rest/projects
   Authorization: Bearer eyJhbGciOiJSUzI1NiIs...
   ```

4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∑–∞ 60 —Å–µ–∫ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è):**
   ```
   MCP Server –≤–∏–¥–∏—Ç: —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ—á–µ—Ç —á–µ—Ä–µ–∑ 50 —Å–µ–∫—É–Ω–¥
   ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑—É—è refresh_token
   ‚Üí –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π access_token
   ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
   ```

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö Flow

| Flow | –¢—Ä–µ–±—É–µ—Ç user interaction? | –î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π? | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|------|---------------------------|---------------|-------------------|
| **client_credentials** | ‚ùå –ù–µ—Ç | ‚ö†Ô∏è –ù–µ—Ç (—Ç–æ–ª—å–∫–æ access_token) | Service-to-service, –±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **authorization_code** | ‚úÖ –î–∞ (–æ–¥–∏–Ω —Ä–∞–∑) | ‚ö†Ô∏è –ù–µ—Ç (—Ç–æ–ª—å–∫–æ access_token) | –ü—É–±–ª–∏—á–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã, SPA |
| **authorization_code + PKCE** | ‚úÖ –î–∞ (–æ–¥–∏–Ω —Ä–∞–∑) | ‚ö†Ô∏è –ù–µ—Ç (—Ç–æ–ª—å–∫–æ access_token) | –ü—É–±–ª–∏—á–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –±–µ–∑ client_secret |
| **refresh_token** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (–¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π) | –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è refresh_token |

## –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Refresh Token?

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Authorization Code Flow (–æ–¥–∏–Ω —Ä–∞–∑)

1. **–ü–æ–ª—É—á–∏—Ç—å authorization_code** (—á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä):
   ```
   https://testping-sso.eisgroup.com/as/authorization.oauth2?
     response_type=code&
     client_id=OpenL_Studio&
     scope=openid%20profile%20email&
     redirect_uri=https://dc3eisovpn03-fast.eisgroup.com/oauth2/callback
   ```

2. **–û–±–º–µ–Ω—è—Ç—å authorization_code –Ω–∞ —Ç–æ–∫–µ–Ω—ã:**
   ```bash
   curl -X POST https://testping-sso.eisgroup.com/as/token.oauth2 \
     -H "Authorization: Basic $(echo -n 'OpenL_Studio:Exigen/2024.02' | base64)" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "grant_type=authorization_code&code=AUTHORIZATION_CODE&redirect_uri=REDIRECT_URI"
   ```

3. **–í –æ—Ç–≤–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å refresh_token:**
   ```json
   {
     "access_token": "...",
     "refresh_token": "xgTuyOxzsnmCx2RQirXKX0uGcGqj6lvfZcP.PUmF6M",  ‚Üê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å!
     "expires_in": 3600
   }
   ```

4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å refresh_token –≤ compose.yaml:**
   ```yaml
   OPENL_OAUTH2_GRANT_TYPE: refresh_token
   OPENL_OAUTH2_REFRESH_TOKEN: "–ø–æ–ª—É—á–µ–Ω–Ω—ã–π_refresh_token"
   ```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

```bash
cd mcp-server
./get-refresh-token.sh
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Refresh Token Flow

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
‚úÖ **–î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π** - refresh_token –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –Ω–µ–¥–µ–ª–∏/–º–µ—Å—è—Ü—ã  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - access_token –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π (1 —á–∞—Å), refresh_token —Ö—Ä–∞–Ω–∏—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - MCP —Å–µ—Ä–≤–µ—Ä —Å–∞–º –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã  
‚úÖ **–ò–¥–µ–∞–ª–µ–Ω –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤** - –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è Docker, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤, —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á  

## –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - –Ω—É–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ–ª—É—á–∏—Ç—å refresh_token  
‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç client_secret** - –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (SPA)  
‚ö†Ô∏è **–ú–æ–∂–µ—Ç –∏—Å—Ç–µ—á—å** - –µ—Å–ª–∏ refresh_token –∏—Å—Ç–µ–∫, –Ω—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è  

## –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ

–£ –≤–∞—Å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç **refresh_token flow**:

```yaml
# compose.yaml (—Å—Ç—Ä–æ–∫–∏ 86-93)
OPENL_OAUTH2_GRANT_TYPE: refresh_token
OPENL_OAUTH2_REFRESH_TOKEN: "xgTuyOxzsnmCx2RQirXKX0uGcGqj6lvfZcP.PUmF6M"
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- ‚úÖ MCP —Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç access_token –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –ø–µ—Ä–µ–¥ –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç "–∏–∑ –∫–æ—Ä–æ–±–∫–∏" –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Docker

## –ö–æ–≥–¥–∞ Refresh Token –∏—Å—Ç–µ–∫–∞–µ—Ç?

–ï—Å–ª–∏ `refresh_token` –∏—Å—Ç–µ–∫, –≤—ã —É–≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É:
```
Failed to obtain OAuth 2.1 token: invalid_grant
```

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ:
1. –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π `refresh_token` —á–µ—Ä–µ–∑ authorization_code flow
2. –û–±–Ω–æ–≤–∏—Ç—å `OPENL_OAUTH2_REFRESH_TOKEN` –≤ `compose.yaml`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

## –†–µ–∑—é–º–µ

**Refresh Token Flow** ‚Äî —ç—Ç–æ —Å–∞–º—ã–π —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:
- –ù–∞—Å—Ç—Ä–æ–∏–ª –æ–¥–∏–Ω —Ä–∞–∑ ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è Docker/—Å–µ—Ä–≤–µ—Ä–æ–≤
- –£ –≤–∞—Å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å!

