#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# OpenL Tablets Prepare Commit Message Hook
# Validates commit message format
# Supports both GitHub (Conventional Commits) and GitLab (EPBDS-XXX Jira format)

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Skip if amending, merging, or using commit template
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "template" ]; then
  exit 0
fi

# Skip for --amend commits
if [ "$COMMIT_SOURCE" = "commit" ]; then
  exit 0
fi

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Check if message starts with a comment (interactive rebase, etc.)
if echo "$COMMIT_MSG" | grep -q "^#"; then
  exit 0
fi

# Detect remote repository to determine format
# Check if we're pushing to GitLab (contains EPBDS repo) or GitHub
REMOTE_URL=$(git config --get remote.origin.url 2>/dev/null || echo "")

# GitLab Jira ticket pattern: EPBDS-1234 description
# Format: EPBDS-<number> <description>
gitlab_jira_regex='^EPBDS-[0-9]+ .{3,100}$'

# GitHub Conventional Commits pattern
# Format: <type>(<scope>): <description>
github_conventional_regex='^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|security)(\([A-Z][A-Za-z0-9-]*\))?: .{3,100}$'

# Check GitLab Jira format first
if echo "$COMMIT_MSG" | grep -qE "$gitlab_jira_regex"; then
    echo "✅ GitLab Jira format detected: EPBDS-XXX"
    exit 0
fi

# Check GitHub Conventional Commits format
if echo "$COMMIT_MSG" | grep -qE "$github_conventional_regex"; then
    echo "✅ GitHub Conventional Commits format detected"
    exit 0
fi

# If neither format matches, show error with both options
echo "❌ Invalid commit message format!"
echo ""
echo "This repository supports two commit message formats:"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "1️⃣  GitLab/Jira Format (for GitLab repository)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Format: EPBDS-<number> <description>"
echo ""
echo "Examples:"
echo "  EPBDS-1234 Add dark mode toggle to settings"
echo "  EPBDS-5678 Fix memory leak in rule parser"
echo "  EPBDS-9012 Update README with installation steps"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "2️⃣  GitHub Conventional Commits Format"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Format: <type>(<scope>): <description>"
echo ""
echo "Examples:"
echo "  feat(STUDIO): add dark mode toggle"
echo "  fix(DEV): resolve memory leak in parser"
echo "  docs: update README with quick start"
echo "  refactor(WSFrontend): extract service logic"
echo ""
echo "Valid types:"
echo "  feat, fix, docs, style, refactor, perf, test,"
echo "  chore, ci, build, security"
echo ""
echo "Valid scopes (optional):"
echo "  DEV, STUDIO, WSFrontend, Util, ITEST, DEMO"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Your commit message:"
echo "  $COMMIT_MSG"
echo ""
echo "To skip this check, use: git commit --no-verify"
exit 1
