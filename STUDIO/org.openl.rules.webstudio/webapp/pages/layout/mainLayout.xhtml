<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich">

    <c:set var="contextPath" value="#{facesContext.externalContext.request.contextPath}" />
    <c:set var="pathRoot" value="#{contextPath}/faces/pages/modules" />

    <h:head>
        #{mainBean.init}

        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <link href="#{contextPath}/css/bootstrap.min.css" rel="stylesheet" />
        <link href="#{contextPath}/css/common.css" rel="stylesheet" />
        <link href="#{contextPath}/css/layout/main.css" rel="stylesheet" />
        <link href="#{contextPath}/css/jquery.popup.css" rel="stylesheet" />
        <link href="#{contextPath}/css/jquery.multiselect.css" rel="stylesheet" />
        <link href="#{contextPath}/css/rulesDependencies.css" rel="stylesheet" />

        <link href="#{contextPath}/faces/tableEditor/css/tableeditor.min.css" rel="stylesheet" />

        <script src="#{contextPath}/javascript/common.js"></script>
        <script src="#{contextPath}/javascript/jquery-1.7.2.min.js"></script>
        <script src="#{contextPath}/javascript/bootstrap.min.js"></script>
        <script src="#{contextPath}/javascript/jquery-ui-1.8.16.custom.min.js"></script>
        <script src="#{contextPath}/javascript/jquery.layout.js"></script>
        <script src="#{contextPath}/javascript/jquery.popup.js"></script>
        <script src="#{contextPath}/javascript/jquery.multiselect.js"></script>
        <script src="#{contextPath}/javascript/bomjs.js"></script>
        <h:outputScript name="jsf.js" library="javax.faces" />

        <script>
          //<![CDATA[
            var HOME_PAGE = "home.xhtml";

            var $j = $.noConflict();

            var loadingPanel;

            var reqs = 0;

            $j.ajaxSetup({
                handleLoginPage: true,
                cache: false,
                beforeSend: showLoader,
                success: hideLoader,
                // Handle jQuery AJAX errors
                error: function(response, message, error) {
                    hideLoader();
                    handleError(response.status);
                }
            });

            $j.ajaxPrefilter(function( options, _, jqXHR ) {
                if (options.handleLoginPage) {
                     var deferredRequest = $j.Deferred();

                     jqXHR.done(
                         function (data) {
                             if (typeof(data) == "string" && data.indexOf("OPENL_LOGIN_PAGE") != -1) {
                                 location.href = "#{contextPath}/faces/pages/sessionExpired.xhtml";
                             } else {
                                 deferredRequest.resolveWith(this, arguments);
                             }
                         }
                     );

                     deferredRequest.promise(jqXHR);

                     jqXHR.success = jqXHR.done;
                }
            });

            // Fix Mojarra bug. Make rerendered forms work.
            // See http://java.net/jira/browse/JAVASERVERFACES_SPEC_PUBLIC-790
            jsf.ajax.addOnEvent(function (data) {
                if (data.status === "success") {
                    var viewState = $j("partial-response:first changes:first update[id = 'javax.faces.ViewState']", data.responseXML);
                    if (viewState.length) {
                        $j("partial-response:first changes:first update[id != 'javax.faces.ViewState']", data.responseXML).each(function (i, u) {
                            $j("form", document.getElementById(u.getAttribute("id"))).each(function (i, f) {
                                var field = $j("input[name='javax.faces.ViewState']", f);
                                if (!field.length) {
                                    field = $j("<input type=\"hidden\" name=\"javax.faces.ViewState\" />").appendTo(f);
                                }
                                field.val(viewState.text());
                            });
                        });
                    }
                }
            });

            // Handle JSF / Richfaces AJAX errors
            jsf.ajax.addOnError(function (data) {
                if (typeof console != "undefined") console.error(data);

                // @Deprecated
                var errorMessage = data.errorMessage;
                if (errorMessage) {
                    // TODO Create mechanism to disable editing in UI when Excel file is opened.
                    if (errorMessage.indexOf(".xls") > -1) {
                        message("#{msg['ws.common.error.save']}", 7000);
                    } else if (data.errorName && data.errorName.indexOf("ViewExpiredException") > -1) {
                        reloadCurrent();
                    } else {
                        message(errorMessage, 7000);
                    }
                    return;
                }

                handleError(data.responseCode);
            });

            var urlRewrite = {
                prefix: "#{pathRoot}/"
            }

            var lastSavedHash = $location.getHash();

            $j(window).bind("hashchange", function() {
                var ch = $location.getHash();
                if (ch != lastSavedHash && ch == decodeURIComponent(lastSavedHash)) {
                    // Workaround for a bug in firefox. Sometimes it decodes a loading url and then loads decoded url.
                    location.hash = lastSavedHash;
                    return;
                } else {
                    lastSavedHash = ch;
                }

                loadContent(getCurrentPage());
            });

            var mainLayout;
            var centerLayout;

            $j(function () {
                mainLayout = $j("#center").layout({
                    spacing_open: 1,
                    spacing_closed: 17,
                    minSize: 110,
                    west__size: 230,
                    east__size: 230,
                    east__initHidden: true,
                    slidable: false,
                    enableCursorHotkey: false
                });
                mainLayout.addCloseBtn("#west-closer", "west");
                mainLayout.addCloseBtn("#east-closer", "east");

                centerLayout = $j("#center .ui-layout-center").layout({
                    spacing_open: 1,
                    spacing_closed: 17,
                    minSize: 57,
                    south__size: 110,
                    slidable: false,
                    enableCursorHotkey: false
                });
                centerLayout.addCloseBtn("#south-closer", "south");

                loadingPanel = $j("#loadingPanel");
                loadContent();

                $j("body").css({"visibility": "visible"});
            });

            function toggleProblems(show) {
                if (show) {
                    centerLayout.show("south");
                } else {
                    centerLayout.hide("south");
                }
            }

            function handleError(code) {
                if (code == 399) { // Session Timeout
                    location.href = "#{contextPath}/faces/pages/sessionExpired.xhtml";
                } else if (code == 404) { // File Not Found
                    message("#{msg['ws.common.error.404']}", 7000);
                } else {
                    message("#{msg['ws.common.error.500']}", 7000);
                }
            }

            var ws = {
                nav: {
                  reload: function(params) {
                      if (!params) {
                          loadContent();
                      } else {
                          var currentPage = getCurrentPage();
                          var newPage = $location.utils.setParams(currentPage, params);
                          goTo(newPage);
                      }
                  },
                  home: function() {
                      loadContent(urlRewrite.prefix + HOME_PAGE);
                  }
                }
            }

            // Deprecated
            // TODO Move to ws.nav namespace
            function search(params) {
                var query;

                if (params) {
                    // Simple Search by text
                    if (params.constructor === String) {
                        query = "query=" + encodeURIComponent(params);

                    // Advanced Search
                    } else {
                        query = $j.param(params);
                    }
                }

                goTo("search.xhtml" + (query ? "?" + query : ""));
            }

            // Deprecated
            // TODO Move to ws.nas namespace
            function goTo(page, reload) {
                if (page) {
                    page = page.replace(urlRewrite.prefix, "");
                    // Check if requested page is the same as current
                    if (decodeURIComponent(page.replace(/^#/, '')) == $location.getHash(true)) {
                        loadContent();
                    } else {
                        location.hash = page;
                    }
                }

                if (reload) {
                    reloadTop();
                    reloadLeft();
                    reloadBottom();
                }
            }

            // Deprecated
            // TODO Move to ws.nas namespace
            function reloadCurrent() {
                reloadTop();
                reloadLeft();
                reloadBottom();
                loadContent();
            }

            function reloadTop() {
                $j("#top").load(urlRewrite.prefix + "topPanel.xhtml");
            }

            function reloadLeft() {
                $j("#leftContent").load(urlRewrite.prefix + "leftPanel.xhtml", function() {
                    reopenLeftPanel();
                });
            }

            function reloadBottom() {
                $j("#bottomContent").load(urlRewrite.prefix + "bottomPanel.xhtml");
            }

             // Deprecated
             // TODO Move to ws namespace
             function getCurrentPage() {
                if (location.hash) {
                    var page = lastSavedHash;
                    if (page && page.indexOf(urlRewrite.prefix) < 0) {
                        page = urlRewrite.prefix + page;
                    }
                    return page;
                }
             }

             function loadContent(page) {
                var page = page || getCurrentPage();

                if (page) {
                    $j("#content").load(page);

                    if (page.indexOf(HOME_PAGE) > -1 || page.indexOf("project.xhtml") > -1) {
                        toProjectsPanel();
                        reloadTop();
                        $j("#rulesTree, #problemsTree").hide();
                        toggleProblems(false);
                    } else {
                        toggleProblems(true);

                        var header;
                        if (page.indexOf("module.xhtml") > -1) {
                            var headerParts = $location.utils.getParamsQuery(page).split("/");
                            header = decodeURIComponent(headerParts[0] + " > " + headerParts[1]);
                        }
                        toRulesPanel(header);
                    }

                    if (page.indexOf("table.xhtml") > -1) {
                        mainLayout.show("east");
                        $j("#tableProperties").load(
                                urlRewrite.prefix + "tableDetailsData.xhtml?"
                                + $location.utils.getParamsQuery(page));
                        openTreeNode(page);
                    } else {
                        mainLayout.hide("east");
                    }
                } else {
                    ws.nav.home();
                }
            }

            function openTreeNode(page) {
                var page = page || getCurrentPage();

                if (page && page.indexOf("table.xhtml") > -1) {
                    var tableId = page.split("uri=")[1].split("&")[0];
                    var tableLink = $j("#rulesTree a[href *= '" + tableId + "']");
                    if (tableLink.length) { // Firefox has bug with decoding url after refresh
                        // Expand nodes
                        tableLink.parents(".rf-tr-nd-colps").each(function() {
                            var node = $j(this);
                            node.toggleClass("rf-tr-nd-colps rf-tr-nd-exp");
                            node.find(".rf-trn-hnd-colps:first").toggleClass("rf-trn-hnd-colps rf-trn-hnd-exp");
                        });
                        // Select node
                        $j("#rulesTree .rf-trn-sel").removeClass("rf-trn-sel");
                        tableLink.closest(".rf-trn-cnt").addClass("rf-trn-sel");
    
                        /*tableLink.closest(".view_workspace").animate({
                            scrollTop: tableLink.offset().top
                        });*/
                    }
                }
            }

            var NAVI_HEADER_ITEM = "naviHeader";
            var SHOW_HISTORY_ITEM = "showHistory";

            function toProjectsPanel() {
                sessionStorage.removeItem(NAVI_HEADER_ITEM);
                sessionStorage.removeItem(SHOW_HISTORY_ITEM);
                $j("#navigationHeader").text("Projects");
                $j("#navigationHeader").removeAttr("title");

                $j("#projectsTreePanel").show();
                $j("#rulesTreePanel").hide();
                $j("#recentVisitedTablesPanel").hide();
            }

            function toRulesPanel(header) {
                if (sessionStorage.getItem(SHOW_HISTORY_ITEM)) {
                    toHistoryPanel();
                    return;
                }

                if (!header) {
                    header = sessionStorage.getItem(NAVI_HEADER_ITEM);
                }

                if (header) {
                    sessionStorage.setItem(NAVI_HEADER_ITEM, header);
                    $j("#navigationHeader").text(header);
                    $j("#navigationHeader").attr("title", header);    
                }

                $j("#projectsTreePanel").hide();
                $j("#rulesTreePanel").show();
                $j("#recentVisitedTablesPanel").hide();
            }

            function toHistoryPanel() {
                header = sessionStorage.getItem(NAVI_HEADER_ITEM);
                
                $j("#navigationHeader").text(header);
                $j("#navigationHeader").attr("title", header);

                $j("#projectsTreePanel").hide();
                $j("#rulesTreePanel").hide();
                $j("#recentVisitedTablesPanel").show();
            }

            function reopenLeftPanel() {
                if (sessionStorage.getItem(NAVI_HEADER_ITEM)) {
                    toRulesPanel();
                } else {
                    toProjectsPanel();
                }
            }

            function showLoader() {
                if (reqs++ == 0) {
                    loadingPanel.show();
                }
            }

            function hideLoader() {
                if (reqs-- == 1) {
                    loadingPanel.hide();
                }
            }

            // Deprecated
            // TODO Move to ws.ui namespace
            function showPopupMenu(event, popupId, elem, params) {
                var elem = $j(elem);
                var elemPos = elem.position();

                var left = elemPos.left + ((params && params.offsetLeft) || 0);
                var top = elemPos.top + elem.outerHeight() + ((params && params.offsetTop) || 0);
                var closeIcon = (params && params.closeIcon && 'webresource/images/close.gif') || false;

                var popupParams = {
                    caller   : event.target,
                    left     : left,
                    top      : top,
                    closeIcon: closeIcon
                };
                if (params && params.fitToScreen === true) {
                    popupParams.maxWidth = "calc(100% - " + left + "px)";
                    popupParams.maxHeight = "calc(100% - " + top + "px)";
                }

                $j("#" + popupId).popup(popupParams);
            }

            // Deprecated
            // TODO Move to ws.ui namespace
            function message(content, life, closable) {
                var messages = $j(".message");

                function remove() {
                    message.remove();

                    var top = 33;
                    $j(".message").each(function() {
                        $j(this).css({"top" : top + "px"});
                        top += ($j(this).outerHeight() + 5);
                    });
                }

                var message = $j("<div />").addClass("message").html(content);

                if (closable !== false) {
                    message.css({"cursor" : "pointer"})
                    message.click(remove);
                }

                var top;
                if (messages.length) {
                    var lastMessage = $j(messages[messages.length - 1]);
                    top = lastMessage.position().top + lastMessage.outerHeight() + 5 + "px";
                } else {
                    top = "33px";
                }

                message.css({"top": top});
                $j("body").append(message);

                if (life > -1) {
                    setTimeout(remove, life);
                }
            }
          //]]>
        </script>

        <title>
            <ui:insert name="title">OpenL Tablets WebStudio</ui:insert>
        </title>
    </h:head>

    <h:body style="visibility: hidden">
        <script src="webresource/js/prototype/prototype-1.6.1.js"></script>

        <div id="header">
            <ui:insert name="header">
                <ui:include src="/pages/common/header.xhtml">
                    <ui:param name="menu" value="rules" />
                </ui:include>
            </ui:insert>
        </div>

        <div id="top">
            <ui:insert name="top">
                <ui:include src="/pages/modules/topPanel.xhtml" />
            </ui:insert>
        </div>

        <div id="center">
            <h:panelGroup id="left" class="ui-layout-west" layout="block">
                <span id="west-closer" class="pane-closer" title="#{msg['ws.common.icon.close']}" />
                <ui:insert name="left">
                    <div id="leftContent">
                        <ui:include src="/pages/modules/leftPanel.xhtml" />
                    </div>
                </ui:insert>
            </h:panelGroup>
            <h:panelGroup class="ui-layout-center" layout="block">
                <h:panelGroup id="content" class="ui-layout-center" layout="block">
                    <ui:insert name="content" />
                </h:panelGroup>
                <h:panelGroup id="bottom" class="ui-layout-south" layout="block">
                    <span id="south-closer" class="pane-closer" title="#{msg['ws.common.icon.close']}" />
                    <div id="bottomContent">
                        <ui:include src="/pages/modules/bottomPanel.xhtml" />
                    </div>
                </h:panelGroup>
            </h:panelGroup>
            <h:panelGroup id="right" class="ui-layout-east" layout="block">
                <span id="east-closer" class="pane-closer" title="#{msg['ws.common.icon.close']}" />
                <ui:insert name="right">
                    <ui:include src="/pages/modules/rightPanel.xhtml" />
                </ui:insert>
            </h:panelGroup>
        </div>

        <div id="footer">
            <ui:insert name="footer">
                <ui:include src="/pages/common/footer.xhtml" />
            </ui:insert>
        </div>

        <div id="loadingPanel" style="display: none">
            <img src="webresource/images/ajax-loader.gif" />
        </div>

        <div style="display: none">
            <a4j:status onstart="showLoader()" onstop="hideLoader()" />

            <iframe src="#{contextPath}/faces/pages/modules/sourceModified.xhtml" width="0" height="0" />
            <iframe name="hidden" width="0" height="0" />

            <!-- Init RichFaces resources -->
            <rich:popupPanel />
            <rich:calendar />
            <rich:inputNumberSpinner />
            <rich:dataTable />
         </div>

    </h:body>
</html>
