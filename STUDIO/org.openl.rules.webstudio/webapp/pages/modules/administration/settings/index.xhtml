<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
        template="/pages/layout/adminLayout.xhtml"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:c="http://java.sun.com/jsp/jstl/core"
        xmlns:a4j="http://richfaces.org/a4j"
        xmlns:rich="http://richfaces.org/rich"
        xmlns:fn="http://java.sun.com/jsp/jstl/functions">
    <ui:define name="content">
        <c:set var="emptyHistoryDir" value="#{fn:length(projectsInHistory.projects) == 0}"/>
        <c:set var="isNotSingleMode" value="#{environment.getProperty('user.mode') != 'single'}"/>

        <style>
            .restartMessage {
                position: fixed;
                top: 85px;
                right: 33px;
            }

            .repositoryConfigButton {
                vertical-align: top;
            }

            .addRepositoryConfig {
                margin-top: 10px;
            }

            .historyHeader {
                height: 10px;
                padding: 8px 6px;
                color: black;
            }

            .history {
                width: 270px;
                border: 1px solid #ccc;
                margin-top: 2px;
            }

            .historyChecks {
                max-height: 124px;
                width: 270px;
                overflow: auto;
                border-top: 1px solid #ccc;
                border-bottom: 1px solid #ccc;
                margin-top: 0;
            }

            .historyCheckAll {
                width: 270px;
                border-top: 1px solid #ccc;
                margin-top: 2px;
            }

            .tab-panel-vertical > ul li.tab-group {
                padding: 10px 5px;
            }

            .tab-panel-vertical > ul .sub-repo-item {
                padding-left: 25px;
            }

            .tab-panel-vertical .repo-tab > ul li {
                text-align: left;
                width: 170px;
            }

            .tab-panel-vertical .repo-tab > ul li a {
                padding: 10px 5px;
            }

            .tab-panel-vertical .repo-tab > ul li > div a,
            .tab-panel-vertical > ul li > div a span {
                display: inline;
            }

            .section-description {
                max-width: 555px;
            }
        </style>

        <script>
            //<![CDATA[
            $j(function () {
                initSettingsPage();
            });

            function switchToRepositoryTab() {
                location.hash = 'repository';
            }

            function initSettingsPage() {
                $j('#tab-container').easytabs({
                    animate: false,
                    tabActiveClass: "selected-tab",
                    panelActiveClass: "displayed"
                });
                $j('#repo-tab-container').easytabs({
                    tabs: '.tab-element',
                    defaultTab: '.default-tab',
                    animate: false,
                    tabActiveClass: "selected-tab",
                    panelActiveClass: "displayed"
                });

                if (#{emptyHistoryDir}) {
                    $j("#cleanHistoryHref").hide();
                }

                $j('.no-autocomplete').attr('autocomplete', 'new-input-field');

                $j.ajax({
                    url: "#{contextPath}/web/public/notification.txt",
                    datatype: "text"
                })
                    .done(function (data) {
                        $j("#notification textarea").val(data);
                    });
                $j("#notification input").on("click", function (e) {
                    e.preventDefault();
                    if (e.target.value == "Remove") {
                        $j("#notification textarea").val(null);
                    }
                    $j.ajax({
                        type: "POST",
                        contentType: 'text/plain',
                        url: "#{contextPath}/web/admin/notification.txt",
                        data: jQuery("#notification textarea").val(),
                        async: false,
                        beforeSend: showLoader
                    })
                        .always(function () {
                            hideLoader();
                            // FIXME: $j is not the same as jQuery
                            // refresh event registered in the jQuery object
                            jQuery('#notificationPanel').trigger('refresh');
                        });
                });

            }

            function changeStatus(element) {
                $j("#avaliableProjectsInHistory INPUT[type='checkbox']").attr('checked', element.checked);
                if (element.checked) {
                    $j("#systemSettingsForm\\:sbtClean").removeAttr('disabled');
                } else {
                    $j("#systemSettingsForm\\:sbtClean").attr('disabled', 'disabled');
                }
            }

            function showAvailableProjectsInHistory(showHistory) {
                if (showHistory) {
                    $j("#avaliableProjectsInHistory").show();
                    onProjectChecked();
                } else {
                    $j("#avaliableProjectsInHistory INPUT[type='checkbox']").attr('checked', false);
                    $j("#avaliableProjectsInHistory").hide();
                }
                if (#{emptyHistoryDir}) {
                    $j("#cleanHistoryHref").hide();
                }
            }

            function onProjectChecked() {
                var checkedCount = $j("#avaliableProjectsInHistory INPUT[type='checkbox']:checked").not("#systemSettingsForm\\:selectAll").size();
                var allCount = $j("#avaliableProjectsInHistory INPUT[type='checkbox']").not("#systemSettingsForm\\:selectAll").size();

                $j("#systemSettingsForm\\:selectAll").attr('checked', checkedCount === allCount);

                if (checkedCount > 0) {
                    $j("#systemSettingsForm\\:sbtClean").removeAttr('disabled');
                } else {
                    $j("#systemSettingsForm\\:sbtClean").attr('disabled', 'disabled');
                }
            }

            function changeRunTestsInParallel(element) {
                if (element.checked) {
                    $j("#systemSettingsForm\\:testRunThreadCount").show();
                } else {
                    $j("#systemSettingsForm\\:testRunThreadCount").hide();
                }
            }

            function confirmSave() {
                return !#{isNotSingleMode} || confirm('All users working with WebStudio now will lose all unsaved changes. Are you sure you want to apply these settings now?');
            }

            //]]>
        </script>

        <div class="simpleView_workspace">
            <div>

                <!-- This is a workaround. See https://stackoverflow.com/questions/15738259/disabling-chrome-autofill for details. -->
                <input style="display:none" type="password" name="fake-password-field" autocomplete="new-password"/>

                <c:set var="validator" value="#{systemSettingsBean.validator}"/>

                <h:panelGroup id="restartMessage" layout="block" styleClass="restartMessage">
                    <h:panelGroup rendered="#{studio.needRestart}" layout="block" styleClass="problem-warning">
                        <b>System settings were changed!</b>
                        <br/>Refresh the page.
                    </h:panelGroup>
                </h:panelGroup>

                <div id="tab-container" class="tab-panel-vertical outer-tab">
                    <ul>
                        <li>
                            <a href="#common">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/common.png"
                                                alt="Common"/>
                                <span>Common</span>
                            </a>
                        </li>
                        <li>
                            <a href="#repository">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/repository.png"
                                                alt="Repository"/>
                                <span>Repository</span>
                            </a>
                        </li>
                        <li>
                            <a href="#system">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/java_system.png"
                                                alt="Java System"/>
                                <span>System</span>
                            </a>
                        </li>
                        <c:if test="#{usersBean.canCreateUsers}">
                            <li>
                                <a href="#users">
                                    <h:graphicImage url="/webresource/images/admin/users/users.png" alt="Users"/>
                                    <span>Users</span>
                                </a>
                            </li>
                        </c:if>
                        <c:if test="#{isNotSingleMode}">
                            <li>
                                <a href="#groups">
                                    <h:graphicImage url="/webresource/images/admin/users/groups.png"
                                                    alt="Groups &amp; Privileges"/>
                                    <span>Groups &amp; Privileges</span>
                                </a>
                            </li>
                        </c:if>
                        <li>
                            <a href="#notification">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/notification.png"
                                                alt="Notification"/>
                                <span>Notification</span>
                            </a>
                        </li>
                        <br style="clear:both;"/>
                    </ul>
                    <div class="data-container">
                        <h:form id="systemSettingsForm">
                            <div id="common">
                                <h:panelGroup id="commonProps" styleClass="fields" layout="block">
                                    <section>
                                        <h3>User Workspace</h3>
                                        <div>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Workspace Directory:"/>
                                                <h:inputText id="workspace-dir"
                                                             value="#{systemSettingsBean.userWorkspaceHome}"
                                                             disabled="#{props.isPropertyDisabled('user.workspace.home')}"
                                                             validator="#{validator.workSpaceDirValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="workspace-dir" class="error"/>
                                        </div>
                                    </section>
                                    <section>
                                        <h3>History</h3>
                                        <div id="history">
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="History Directory:"/>
                                                <h:inputText id="history-dir"
                                                             value="#{systemSettingsBean.projectHistoryHome}"
                                                             disabled="#{props.isPropertyDisabled('project.history.home')}"
                                                             validator="#{validator.historyDirValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="history-dir" class="error"/>
                                            <h:panelGrid id="maxCountInHistory" columns="2" columnClasses="titleColumn">
                                                <h:outputText
                                                        value="The maximum count of saved changes for each project:"/>
                                                <h:inputText id="history-count"
                                                             value="#{systemSettingsBean.projectHistoryCount}"
                                                             disabled="#{props.isPropertyDisabled('project.history.count')}"
                                                             validator="#{validator.historyCountValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="history-count" class="error"/>
                                            <h:panelGrid rendered="#{!emptyHistoryDir}">
                                                <a href="javascript:void(0)" id="cleanHistoryHref" title="Clean history"
                                                   onclick="showAvailableProjectsInHistory(true)">Clean history</a>
                                            </h:panelGrid>
                                        </div>
                                        <div id="avaliableProjectsInHistory" class="history" style="display:none">
                                            <h:panelGroup id="projectsInHistoryPanel" layout="block">
                                                <div class="historyHeader">
                                                    <b>Clean projects history</b>
                                                </div>
                                                <div class="historyCheckAll">
                                                    <h:panelGrid columns="2">
                                                        <h:selectBooleanCheckbox id="selectAll"
                                                                                 title="Select/Deselect All'"
                                                                                 onclick="changeStatus(this);"/>
                                                        <h:outputText value="Name" style="font-weight:bold"/>
                                                    </h:panelGrid>
                                                </div>
                                                <div class="historyChecks">
                                                    <ui:repeat value="#{projectsInHistory.projects}" var="project">
                                                        <h:panelGrid columns="2">
                                                            <h:selectBooleanCheckbox value="#{project.selected}"
                                                                                     onclick="onProjectChecked()"/>
                                                            <h:outputText value="#{project.projectName}"/>
                                                        </h:panelGrid>
                                                    </ui:repeat>
                                                </div>
                                                <div>
                                                    <h:panelGrid columns="2">
                                                        <a4j:commandButton id="sbtClean" value="Clean"
                                                                           title="Clean projects history"
                                                                           action="#{projectsInHistory.deleteProjects}"
                                                                           render="commonProps"
                                                                           oncomplete="showAvailableProjectsInHistory(false)"/>
                                                        <input type="button" value="Cancel" title="Cancel"
                                                               onclick="showAvailableProjectsInHistory(false)"/>
                                                    </h:panelGrid>
                                                </div>
                                            </h:panelGroup>
                                        </div>
                                    </section>
                                    <section>
                                        <h3>Other</h3>
                                        <div>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText
                                                        value="Update table properties ('createdOn', 'modifiedBy' etc.) on editing: "/>
                                                <h:selectBooleanCheckbox
                                                        value="#{systemSettingsBean.updateSystemProperties}"
                                                        disabled="#{props.isPropertyDisabled('update.system.properties')}"/>
                                            </h:panelGrid>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Date Format:"/>
                                                <h:inputText id="date-format" value="#{systemSettingsBean.datePattern}"
                                                             disabled="#{props.isPropertyDisabled('data.format.date')}"
                                                             validator="#{validator.dateFormatValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="date-format" class="error"/>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Time Format:"/>
                                                <h:inputText id="time-format" value="#{systemSettingsBean.timePattern}"
                                                             disabled="#{props.isPropertyDisabled('data.format.time')}"
                                                             validator="#{validator.timeFormatValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="time-format" class="error"/>
                                        </div>
                                    </section>
                                </h:panelGroup>
                                <h:panelGroup style="margin-bottom: 15px">
                                    <a4j:commandButton value="Restore Defaults"
                                                       action="#{systemSettingsBean.restoreDefaults}"
                                                       execute="@this"
                                                       render="commonProps repositoryProps javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       title="Restore the default settings"/>
                                    <h:outputText value=" "/>
                                    <a4j:commandButton value="Apply" action="#{systemSettingsBean.applyChanges}"
                                                       render="commonProps repositoryProps javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       styleClass="button-primary" title="Apply changes"/>
                                </h:panelGroup>
                            </div>
                            <div id="repository">
                                <h:panelGroup id="repoSettings" layout="block">
                                <div id="repo-tab-container" class="tab-panel-vertical repo-tab">
                                    <ui:param name="designRepos"
                                              value="#{systemSettingsBean.designRepositoryConfigurations}"/>
                                    <ui:param name="productionRepos"
                                              value="#{systemSettingsBean.productionRepositoryConfigurations}"/>
                                    <ul>
                                        <li class="tab-group">
                                            <div>
                                                <span>Design repositories</span>
                                                <a4j:commandLink
                                                        action="#{systemSettingsBean.addDesignRepository()}"
                                                        title="Add Design Repository Connection"
                                                        styleClass="toolbarButton menuButton"
                                                        render="repoSettings"
                                                        oncomplete="initSettingsPage();"
                                                        onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                        onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})">
                                                    <img src="#{request.contextPath}/webresource/images/add.png"
                                                         alt="Add Repository"/>
                                                </a4j:commandLink>
                                            </div>
                                        </li>
                                        <a4j:repeat value="#{designRepos}" var="repository" rowKeyVar="r">
                                            <li class="sub-repo-item tab-element #{r == 0 ? 'default-tab' : ''}">
                                                <a href="#repo-#{repository.id}">
                                                    <span><h:outputText value="#{repository.name}"/></span>
                                                </a>
                                            </li>
                                        </a4j:repeat>
                                        <li class="tab-element">
                                            <a href="#repo-deploy-config">
                                                <span><h:outputText value="Deploy configuration"/></span>
                                            </a>
                                        </li>
                                        <li class="tab-group">
                                            <div>
                                                <span>Deployment repositories</span>
                                                <a4j:commandLink
                                                        action="#{systemSettingsBean.addProductionRepository()}"
                                                        title="Add Deployment Repository Connection"
                                                        styleClass="toolbarButton menuButton"
                                                        render="repoSettings"
                                                        oncomplete="initSettingsPage();"
                                                        onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                        onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})">
                                                    <img src="#{request.contextPath}/webresource/images/add.png"
                                                         alt="Add Repository"/>
                                                </a4j:commandLink>
                                            </div>
                                        </li>
                                        <a4j:repeat value="#{productionRepos}" var="repository">
                                            <li class="sub-repo-item tab-element">
                                                <a href="#repo-#{repository.id}">
                                                    <span><h:outputText value="#{repository.name}"/></span>
                                                </a>
                                            </li>
                                        </a4j:repeat>
                                    </ul>
                                    <h:panelGroup id="repositoryProps" layout="block">
                                        <section>
                                            <a4j:repeat value="#{designRepos}" var="designRepository">
                                                <div id="repo-#{designRepository.id}">
                                                    <table>
                                                        <tr>
                                                            <td>
                                                                <h:panelGrid id="designInfoPanel" columns="2"
                                                                             columnClasses="titleColumn">
                                                                    <h:outputText value="Name:"/>
                                                                    <h:inputText value="#{designRepository.name}"/>
                                                                    <h:outputText value="Type:"/>
                                                                    <h:selectOneMenu value="#{designRepository.type}">
                                                                        <f:ajax event="change"
                                                                                render="designParameters deployConfigFolderStructureParams designRepoTypeMessage"/>
                                                                        <f:selectItem itemValue="db"
                                                                                      itemLabel="Database (JDBC)"/>
                                                                        <f:selectItem itemValue="jndi"
                                                                                      itemLabel="Database (JNDI)"/>
                                                                        <f:selectItem itemValue="aws_s3" itemLabel="AWS S3"/>
                                                                        <f:selectItem itemValue="git" itemLabel="Git"/>
                                                                    </h:selectOneMenu>
                                                                    <h:outputText value=""/>
                                                                    <h:panelGroup id="designRepoTypeMessage">
                                                                        <h:outputText value="#{designRepository.errorMessage}"
                                                                                      rendered="#{not empty designRepository.errorMessage}"
                                                                                      styleClass="error"/>
                                                                    </h:panelGroup>
                                                                </h:panelGrid>
                                                                <h:panelGroup id="designParameters">
                                                                    <h:panelGroup
                                                                            rendered="#{designRepository.formType == 'common'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/commonRepositorySettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{designRepository}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                            rendered="#{designRepository.formType == 'aws_s3'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/AWSS3RepositorySettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{designRepository}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                            rendered="#{designRepository.formType == 'git'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/GitRepositorySettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{designRepository}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>

                                                                    <h:panelGroup
                                                                            rendered="#{designRepository.folderRepository}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/folderStructureSettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="settings"
                                                                                      value="#{systemSettingsBean.getFolderStructure(designRepository)}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                </h:panelGroup>
                                                            </td>
                                                            <td class="repositoryConfigButton">
                                                                <a4j:commandLink
                                                                        action="#{systemSettingsBean.deleteDesignRepository(designRepository.configName)}"
                                                                        title="Delete Design Repository Connection"
                                                                        styleClass="toolbarButton menuButton"
                                                                        render="repoSettings"
                                                                        rendered="#{designRepos.size() > 1}"
                                                                        onclick="if(!window.confirm('Do you really want to delete repository connection?')) {return false;}"
                                                                        oncomplete="switchToRepositoryTab();initSettingsPage();"
                                                                        onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                                        onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})">
                                                                    <img src="#{request.contextPath}/webresource/images/delete.png"
                                                                         alt="Delete Repository"/>
                                                                </a4j:commandLink>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </a4j:repeat>
                                        </section>
                                        <section>
                                            <c:set var="deployConfigRepo"
                                                   value="#{systemSettingsBean.deployConfigRepositoryConfiguration}"/>

                                            <div id="repo-deploy-config">
                                                <table>
                                                    <tr>
                                                        <td>
                                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                                <h:outputLabel value="Use Design Repository:"
                                                                               for="useDesignRepo"/>
                                                                <h:selectBooleanCheckbox id="useDesignRepo"
                                                                                         value="#{systemSettingsBean.useDesignRepo}"
                                                                                         title="Use Design Repository to store Deploy Configurations">
                                                                    <f:ajax event="change" render="deployConfigInfoPanel"/>
                                                                </h:selectBooleanCheckbox>
                                                            </h:panelGrid>
                                                            <h:panelGroup id="deployConfigInfoPanel">
                                                                <h:panelGrid columns="2" columnClasses="titleColumn">
                                                                    <h:outputText value="Repository:"
                                                                                  rendered="#{systemSettingsBean.useDesignRepo}"/>
                                                                    <h:selectOneMenu
                                                                            rendered="#{systemSettingsBean.useDesignRepo}"
                                                                            value="#{systemSettingsBean.designRepoForDeployConfig}">
                                                                        <f:selectItems
                                                                                value="#{systemSettingsBean.designRepositoryConfigurations}"
                                                                                var="repository"
                                                                                itemValue="#{repository.id}"
                                                                                itemLabel="#{repository.name}"/>
                                                                    </h:selectOneMenu>

                                                                    <h:outputText value="Name:"
                                                                                  rendered="#{not systemSettingsBean.useDesignRepo}"/>
                                                                    <h:inputText value="#{deployConfigRepo.name}"
                                                                                 disabled="true"
                                                                                 rendered="#{not systemSettingsBean.useDesignRepo}"/>
                                                                    <h:outputText value="Type:"
                                                                                  rendered="#{not systemSettingsBean.useDesignRepo}"/>
                                                                    <h:selectOneMenu value="#{deployConfigRepo.type}"
                                                                                     rendered="#{not systemSettingsBean.useDesignRepo}">
                                                                        <f:ajax event="change"
                                                                                render="deployConfigParameters deployConfigFolderStructureParams deployConfigRepoTypeMessage"/>
                                                                        <f:selectItem itemValue="db"
                                                                                      itemLabel="Database (JDBC)"/>
                                                                        <f:selectItem itemValue="jndi"
                                                                                      itemLabel="Database (JNDI)"/>
                                                                        <f:selectItem itemValue="aws_s3"
                                                                                      itemLabel="AWS S3"/>
                                                                        <f:selectItem itemValue="git" itemLabel="Git"/>
                                                                    </h:selectOneMenu>
                                                                    <h:outputText value=""/>
                                                                    <h:panelGroup id="deployConfigRepoTypeMessage">
                                                                        <h:outputText
                                                                                value="#{deployConfigRepo.errorMessage}"
                                                                                rendered="#{not systemSettingsBean.useDesignRepo and not empty deployConfigRepo.errorMessage}"
                                                                                styleClass="error"/>
                                                                    </h:panelGroup>
                                                                </h:panelGrid>
                                                                <h:panelGroup id="deployConfigParameters"
                                                                              rendered="#{not systemSettingsBean.useDesignRepo}">
                                                                    <h:panelGroup
                                                                            rendered="#{deployConfigRepo.formType == 'common'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/commonRepositorySettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{deployConfigRepo}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                            rendered="#{deployConfigRepo.formType == 'aws_s3'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/AWSS3RepositorySettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{deployConfigRepo}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                            rendered="#{deployConfigRepo.formType == 'git'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/GitRepositorySettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{deployConfigRepo}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                </h:panelGroup>
                                                                <h:panelGroup id="deployConfigFolderStructureParams">
                                                                    <h:panelGroup
                                                                            rendered="#{systemSettingsBean.useDesignRepo ? designRepository.folderRepository : deployConfigRepo.folderRepository}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/folderStructureSettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="settings"
                                                                                      value="#{systemSettingsBean.deployConfigFolderStructure}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                </h:panelGroup>
                                                            </h:panelGroup>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </section>
                                        <section>
                                            <div class="repositoryConfig">
                                                <ui:param name="productionRepos"
                                                          value="#{systemSettingsBean.productionRepositoryConfigurations}"/>
                                                <a4j:repeat value="#{productionRepos}" var="repository">
                                                    <div id="repo-#{repository.id}">
                                                        <table>
                                                            <tr>
                                                                <td>
                                                                    <h:panelGrid id="repoInfoPanel" columns="2"
                                                                                 columnClasses="titleColumn">
                                                                        <h:outputText value="Name:"/>
                                                                        <h:inputText value="#{repository.name}"
                                                                                     styleClass="no-autocomplete"/>
                                                                        <h:outputText value="Type:"/>
                                                                        <h:selectOneMenu value="#{repository.type}">
                                                                            <f:ajax event="change"
                                                                                    render="productionParameters"/>
                                                                            <f:selectItem itemValue="db"
                                                                                          itemLabel="Database (JDBC)"/>
                                                                            <f:selectItem itemValue="jndi"
                                                                                          itemLabel="Database (JNDI)"/>
                                                                            <f:selectItem itemValue="aws_s3"
                                                                                          itemLabel="AWS S3"/>
                                                                            <f:selectItem itemValue="git" itemLabel="Git"/>
                                                                        </h:selectOneMenu>
                                                                    </h:panelGrid>
                                                                    <h:panelGroup id="productionParameters">
                                                                        <h:panelGroup
                                                                                rendered="#{repository.formType == 'common'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/commonRepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                        <h:panelGroup
                                                                                rendered="#{repository.formType == 'aws_s3'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/AWSS3RepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                        <h:panelGroup
                                                                                rendered="#{repository.formType == 'git'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/GitRepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                    </h:panelGroup>
                                                                </td>
                                                                <td class="repositoryConfigButton">
                                                                    <a4j:commandLink
                                                                            action="#{systemSettingsBean.deleteProductionRepository(repository.configName)}"
                                                                            title="Delete Deployment Repository Connection"
                                                                            styleClass="toolbarButton menuButton"
                                                                            render="repoSettings"
                                                                            rendered="#{productionRepos.size() > 1}"
                                                                            onclick="if(!window.confirm('Do you really want to delete repository connection?')) {return false;}"
                                                                            oncomplete="switchToRepositoryTab();initSettingsPage();"
                                                                            onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                                            onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})">
                                                                        <img src="#{request.contextPath}/webresource/images/delete.png"
                                                                             alt="Delete Repository"/>
                                                                    </a4j:commandLink>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </a4j:repeat>
                                            </div>

                                        </section>
                                    </h:panelGroup>
                                </div>
                                </h:panelGroup>
                                <h:panelGroup style="margin-bottom: 15px">
                                    <a4j:commandButton value="Restore Defaults"
                                                       action="#{systemSettingsBean.restoreDefaults}"
                                                       execute="@this"
                                                       render="commonProps repoSettings javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       oncomplete="initSettingsPage();"
                                                       title="Restore the default settings"/>
                                    <h:outputText value=" "/>
                                    <a4j:commandButton value="Apply" action="#{systemSettingsBean.applyChanges}"
                                                       render="commonProps repoSettings javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       oncomplete="initSettingsPage();"
                                                       styleClass="button-primary" title="Apply changes"/>
                                </h:panelGroup>

                            </div>
                            <div id="system">
                                <h:panelGroup id="javaProps" styleClass="fields" layout="block">
                                    <section>
                                        <h3>Core</h3>
                                        <div>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Dispatching Validation:"/>
                                                <h:selectBooleanCheckbox
                                                        value="#{systemSettingsBean.dispatchingValidationEnabled}"
                                                        title="Turn on/off the Dispatching Validation feature"/>
                                                <h:outputText value="Verify on Edit:"/>
                                                <h:selectBooleanCheckbox value="#{systemSettingsBean.autoCompile}"
                                                                         title="Turn on/off verification on edit"/>
                                            </h:panelGrid>
                                        </div>
                                    </section>
                                    <section>
                                        <h3>Testing</h3>
                                        <div>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Run test cases of the test in parallel:"/>
                                                <h:selectBooleanCheckbox
                                                        value="#{systemSettingsBean.runTestsInParallel}"
                                                        title="Turn on/off the &quot;Run test cases of the test in parallel&quot; feature"
                                                        onclick="changeRunTestsInParallel(this)"/>
                                            </h:panelGrid>
                                            <h:panelGrid id="testRunThreadCount" columns="2" columnClasses="titleColumn"
                                                         style="#{systemSettingsBean.runTestsInParallel ?'' : 'display:none'}">
                                                <h:outputText value="Thread number for tests:"/>
                                                <h:inputText id="test-nThreads"
                                                             value="#{systemSettingsBean.testRunThreadCount}"
                                                             validator="#{validator.testRunThreadCountValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="test-nThreads" class="error"/>
                                        </div>
                                    </section>
                                </h:panelGroup>
                                <h:panelGroup style="margin-bottom: 15px">
                                    <a4j:commandButton value="Restore Defaults"
                                                       action="#{systemSettingsBean.restoreDefaults}"
                                                       execute="@this"
                                                       render="commonProps repositoryProps javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       title="Restore the default settings"/>
                                    <h:outputText value=" "/>
                                    <a4j:commandButton value="Apply" action="#{systemSettingsBean.applyChanges}"
                                                       render="commonProps repositoryProps javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       styleClass="button-primary" title="Apply changes"/>
                                </h:panelGroup>
                            </div>
                        </h:form>

                        <c:if test="#{usersBean.canCreateUsers}">
                            <div id="users" class="fields">
                                <ui:include src="/pages/modules/administration/users/users.xhtml"/>
                            </div>
                        </c:if>
                        <c:if test="#{isNotSingleMode}">
                            <div id="groups" class="fields">
                                <ui:include src="/pages/modules/administration/users/groups.xhtml"/>
                            </div>
                        </c:if>
                        <div id="notification" class="fields">
                            <section>
                                <h3>Notify all active users</h3>
                                <div>
                                    <table>
                                        <tbody>
                                        <tr>
                                            <td class="titleColumn">Message:</td>
                                            <td><textarea style="height:50px; resize: none" maxlength="250"/></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                            <input type="button" title="Post a message" value="Post"/>
                            <input type="button" title="Remove a message" value="Remove"/>
                        </div>
                    </div>
                </div>

                <ui:include src="/pages/modules/administration/modal/addProductionRepoConnection.xhtml"/>
                <ui:include src="/pages/modules/showInfo.xhtml"/>
            </div>
        </div>

    </ui:define>
</ui:composition>
