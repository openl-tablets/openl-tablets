<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
        template="/pages/layout/adminLayout.xhtml"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:c="http://java.sun.com/jsp/jstl/core"
        xmlns:a4j="http://richfaces.org/a4j"
>
    <ui:define name="content">
        <c:set var="isNotSingleMode" value="#{environment.getProperty('user.mode') != 'single'}"/>

        <style>
            .restartMessage {
                position: fixed;
                top: 85px;
                right: 33px;
            }

            .repositoryConfigButton {
                vertical-align: top;
                opacity: 0;
                transition: visibility 0.1s linear, opacity 0.2s ease-out;
            }

            .tab-element:hover .repositoryConfigButton,
            .selected-tab .repositoryConfigButton {
                opacity: 0.4;
            }

            .tab-panel-vertical > ul li.sub-repo-item a {
                flex: 1;
                min-width: 0; /* required to make text-overflow working */
            }

            .tab-panel-vertical > ul li.sub-repo-item a span {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .addRepositoryConfig {
                margin-top: 10px;
            }

            .historyHeader {
                height: 10px;
                padding: 8px 6px;
                color: black;
            }

            .history {
                width: 270px;
                border: 1px solid #ccc;
                margin-top: 2px;
            }

            .historyChecks {
                max-height: 124px;
                width: 270px;
                overflow: auto;
                border-top: 1px solid #ccc;
                border-bottom: 1px solid #ccc;
                margin-top: 0;
            }

            .historyCheckAll {
                width: 270px;
                border-top: 1px solid #ccc;
                margin-top: 2px;
            }

            .tab-panel-vertical > ul li.tab-group {
                padding: 10px 5px;
                color: gray;
            }

            .tab-panel-vertical > ul li.tab-group:hover {
                opacity: 0.8;
            }

            .tab-element > a > span:before{
                content: url(webresource/images/repository/storage.gif);
                vertical-align: middle;
            }

            .tab-panel-vertical > ul .tab-button,
            .tab-panel-vertical > ul .sub-repo-item {
                padding-left: 25px;
            }

            .tab-panel-vertical > ul .tab-button {
                padding-top: 5px;
                padding-bottom: 5px;
            }

            .tab-panel-vertical .repo-tab > ul li {
                text-align: left;
                width: 170px;
                display: flex;
            }

            .tab-panel-vertical .repo-tab > ul li a {
                padding: 10px 5px;
            }

            .tab-panel-vertical .repo-tab > ul li > div a,
            .tab-panel-vertical > ul li > div a span {
                display: inline;
            }

            .section-description {
                max-width: 555px;
            }

            .restore-defaults-button {
                color: #fff !important;
                box-shadow: none !important;
                background: red !important;
                border-color: red !important;
            }

            .button-panel {
                margin-bottom: 15px;
                padding-top: 4px;
                border-top: 1px solid #ddd;
            }

            #repo-tab-container {
                padding-bottom: 4px;
            }
        </style>

        <script>
            //<![CDATA[
            $j(function () {
                initializeBean();

                $j("#systemSettingsForm").on("keydown", ":input:not(textarea):not(:submit)", function(event) {
                    if(event.keyCode === 13) {
                        event.preventDefault();
                        return false;
                    }
                });
            });

            function switchToRepositoryTab() {
                location.hash = 'repository';
            }

            function initSettingsPage() {
                $j('#tab-container').easytabs({
                    animate: false,
                    tabActiveClass: "selected-tab",
                    panelActiveClass: "displayed"
                });
                $j('#tab-container').bind('easytabs:after', initSubmenuTooltips);
                $j('#repo-tab-container').easytabs({
                    tabs: '.tab-element',
                    defaultTab: '.default-tab',
                    animate: false,
                    tabActiveClass: "selected-tab",
                    panelActiveClass: "displayed"
                });


                $j('.no-autocomplete').attr('autocomplete', 'new-input-field');

                $j.ajax({
                    url: "#{contextPath}/web/public/notification.txt",
                    datatype: "text"
                })
                    .done(function (data) {
                        $j("#notification textarea").val(data);
                    });
                $j("#notification input").on("click", function (e) {
                    e.preventDefault();
                    if (e.target.value == "Remove") {
                        $j("#notification textarea").val(null);
                    }
                    $j.ajax({
                        type: "POST",
                        contentType: 'text/plain',
                        url: "#{contextPath}/web/admin/notification.txt",
                        data: jQuery("#notification textarea").val(),
                        async: false,
                        beforeSend: showLoader
                    })
                        .always(function () {
                            hideLoader();
                            // FIXME: $j is not the same as jQuery
                            // refresh event registered in the jQuery object
                            jQuery('#notificationPanel').trigger('refresh');
                        });
                });
                initSubmenuTooltips();
            }

            function initSubmenuTooltips() {
                $j(".tab-panel-vertical > ul li.sub-repo-item a span").each(function () {
                    let el = $j(this);
                    if (el[0].scrollWidth > el[0].clientWidth) {
                        // If text is truncated, then show tooltip.
                        el.attr("title", el.text());
                    }
                });
            }

            function confirmSave() {
                return !#{isNotSingleMode} || confirm('All users working with OpenL Studio now will lose all unsaved changes. Are you sure you want to apply these settings now?');
            }

            function updateRepoTab(repoId, input) {
                $j('#repo-tab-' + repoId).text($j(input).val());
            }

            function selectLastTab(hrefPrefix) {
                $j('a[href^="' + hrefPrefix + '"]').last().click();
            }

            function deleteAllHistory() {
                if(window.confirm('Do you really want to clear all local changes between revisions for all users and all projects?')) {
                    $j.ajax({
                        type: "DELETE",
                        url: "#{contextPath}/web/history",
                    }).done(function( msg ) {
                        ws.ui.success('Local Changes were deleted successfully.');
                    }).fail(function(response) {
                        handleError(response.status);
                    });
                }
            }
            //]]>
        </script>

        <a4j:jsFunction name="initializeBean"
                        render="commonProps repoSettings javaProps restartMessage"
                        action="#{systemSettingsBean.initialize}"
                        oncomplete="initSettingsPage();"/>

        <div class="simpleView_workspace">
            <div>
                <ui:param name="applyButtonText" value="Apply All and Restart"/>
                <ui:param name="applyButtonTitle" value="Apply all changes and restart OpenL Studio"/>

                <!-- This is a workaround. See https://stackoverflow.com/questions/15738259/disabling-chrome-autofill for details. -->
                <input style="display:none" type="password" name="fake-password-field" autocomplete="new-password"/>

                <c:set var="validator" value="#{systemSettingsBean.validator}"/>

                <h:panelGroup id="restartMessage" layout="block" styleClass="restartMessage">
                    <h:panelGroup rendered="#{studio.needRestart}" layout="block" styleClass="problem-warning">
                        <b>System settings were changed!</b>
                        <br/>Refresh the page.
                    </h:panelGroup>
                </h:panelGroup>

                <div id="tab-container" class="tab-panel-vertical outer-tab">
                    <ul>
                        <li>
                            <a href="#common">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/common.png"
                                                alt="Common"/>
                                <span>Common</span>
                            </a>
                        </li>
                        <li>
                            <a href="#repository">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/repository.png"
                                                alt="Repository"/>
                                <span>Repository</span>
                            </a>
                        </li>
                        <li>
                            <a href="#system">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/java_system.png"
                                                alt="Java System"/>
                                <span>System</span>
                            </a>
                        </li>
                        <c:if test="#{isNotSingleMode}">
                            <li>
                                <a href="#users">
                                    <h:graphicImage url="/webresource/images/admin/users/users.png" alt="Users"/>
                                    <span>Users</span>
                                </a>
                            </li>
                            <li>
                                <a href="#groups">
                                    <h:graphicImage url="/webresource/images/admin/users/groups.png"
                                                    alt="Groups &amp; Privileges"/>
                                    <span>Groups &amp; Privileges</span>
                                </a>
                            </li>
                        </c:if>
                        <li>
                            <a href="#notification">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/notification.png"
                                                alt="Notification"/>
                                <span>Notification</span>
                            </a>
                        </li>
                        <li>
                            <a href="#tags">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/tag.png"
                                                alt="Tags"/>
                                <span>Tags</span>
                            </a>
                        </li>
                        <li>
                            <a href="#mail">
                                <h:graphicImage url="/webresource/images/admin/systemSettings/mail.png"
                                                alt="Mail"/>
                                <span>Mail</span>
                            </a>
                        </li>
                        <br style="clear:both;"/>
                    </ul>
                    <div class="data-container">
                        <h:form id="systemSettingsForm">
                            <div id="common">
                                <h:panelGroup id="commonProps" styleClass="fields" layout="block">
                                    <section>
                                        <h3>History</h3>
                                        <div id="history">
                                            <h:panelGrid id="maxCountInHistory" columns="2" columnClasses="titleColumn">
                                                <h:outputText
                                                        value="The maximum count of saved changes for each project per user:"/>
                                                <h:inputText id="history-count"
                                                             value="#{systemSettingsBean.projectHistoryCount}"
                                                             disabled="#{props.isDisabled('project.history.count')}"
                                                             validator="#{validator.historyCountValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="history-count" class="error"/>
                                        </div>
                                        <div id="avaliableProjectsInHistory" style="margin: 10px">
                                            <input type="button" value="Clear all history" onclick="deleteAllHistory()" title="Clear all changes between revisions for all users and all projects."/>
                                        </div>
                                    </section>
                                    <section>
                                        <h3>Other</h3>
                                        <div>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText
                                                        value="Update table properties ('createdOn', 'modifiedBy' etc.) on editing: "/>
                                                <h:selectBooleanCheckbox
                                                        value="#{systemSettingsBean.updateSystemProperties}"
                                                        disabled="#{props.isDisabled('update.system.properties')}"/>
                                            </h:panelGrid>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Date Format:"/>
                                                <h:inputText id="date-format" value="#{systemSettingsBean.datePattern}"
                                                             disabled="#{props.isDisabled('data.format.date')}"
                                                             validator="#{validator.dateFormatValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="date-format" class="error"/>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Time Format:"/>
                                                <h:inputText id="time-format" value="#{systemSettingsBean.timePattern}"
                                                             disabled="#{props.isDisabled('data.format.time')}"
                                                             validator="#{validator.timeFormatValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="time-format" class="error"/>
                                        </div>
                                    </section>
                                </h:panelGroup>
                                <h:panelGroup styleClass="button-panel" layout="block">
                                    <a4j:commandButton value="${applyButtonText}" action="#{systemSettingsBean.applyChanges}"
                                                       render="commonProps repositoryProps javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       styleClass="button-primary" title="${applyButtonTitle}"/>
                                </h:panelGroup>
                            </div>
                            <div id="repository">
                                <h:panelGroup id="repoSettings" layout="block">
                                <div id="repo-tab-container" class="tab-panel-vertical repo-tab">
                                    <ui:param name="designRepos"
                                              value="#{systemSettingsBean.designRepositoryConfigurations}"/>
                                    <ui:param name="productionRepos"
                                              value="#{systemSettingsBean.productionRepositoryConfigurations}"/>
                                    <ul>
                                        <li class="tab-group">
                                            <div>
                                                <span>Design repositories</span>
                                            </div>
                                        </li>
                                        <a4j:repeat value="#{designRepos}" var="repository" rowKeyVar="r">
                                            <li class="sub-repo-item tab-element #{r == 0 ? 'default-tab' : ''}">
                                                <a href="#repo-#{repository.id}">
                                                    <span id="repo-tab-#{repository.id}"><h:outputText value="#{repository.name}"/></span>
                                                </a>
                                                <span class="repositoryConfigButton">
                                                    <a4j:commandLink
                                                            action="#{systemSettingsBean.deleteDesignRepository(repository.id)}"
                                                            title="Delete Design Repository Connection"
                                                            styleClass="toolbarButton menuButton delete-icon"
                                                            render="repoSettings"
                                                            rendered="#{designRepos.size() > 1}"
                                                            onclick="if(!window.confirm('Do you really want to delete repository connection?')) {return false;}"
                                                            oncomplete="switchToRepositoryTab();initSettingsPage();"
                                                            onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                            onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})"/>
                                                </span>
                                            </li>
                                        </a4j:repeat>
                                        <li class="tab-button">
                                            <a4j:commandButton
                                                    value="Add Repository"
                                                    action="#{systemSettingsBean.addDesignRepository()}"
                                                    title="Add Design Repository Connection"
                                                    render="repoSettings"
                                                    oncomplete="initSettingsPage();selectLastTab('#repo-design');"
                                                    onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                    onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})"/>
                                        </li>

                                        <ui:fragment rendered="#{not empty productionRepos}">
                                        <li class="tab-group">
                                            <div>
                                                <span>Deploy Configuration repository</span>
                                            </div>
                                        </li>

                                        <li class="sub-repo-item tab-element">
                                            <a href="#repo-deploy-config">
                                                <span><h:outputText value="Deploy Configuration"/></span>
                                            </a>
                                        </li>
                                        </ui:fragment>

                                        <li class="tab-group">
                                            <div>
                                                <span>Deployment repositories</span>
                                            </div>
                                        </li>
                                        <a4j:repeat value="#{productionRepos}" var="repository">
                                            <li class="sub-repo-item tab-element">
                                                <a href="#repo-#{repository.id}">
                                                    <span id="repo-tab-#{repository.id}"><h:outputText value="#{repository.name}"/></span>
                                                </a>
                                                <span class="repositoryConfigButton">
                                                    <a4j:commandLink
                                                            action="#{systemSettingsBean.deleteProductionRepository(repository.configName)}"
                                                            title="Delete Deployment Repository Connection"
                                                            styleClass="toolbarButton menuButton delete-icon"
                                                            render="repoSettings"
                                                            onclick="if(!window.confirm('Do you really want to delete repository connection?')) {return false;}"
                                                            oncomplete="switchToRepositoryTab();initSettingsPage();"
                                                            onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                            onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})"/>
                                                </span>

                                            </li>
                                        </a4j:repeat>
                                        <li class="tab-button">
                                            <a4j:commandButton
                                                    value="Add Repository"
                                                    action="#{systemSettingsBean.addProductionRepository()}"
                                                    title="Add Deployment Repository Connection"
                                                    render="repoSettings"
                                                    oncomplete="initSettingsPage();selectLastTab('#repo-production');"
                                                    onmouseover="$j(this).find('.arrow').css({'visibility':'visible'})"
                                                    onmouseout="$j(this).find('.arrow').css({'visibility':'hidden'})"/>
                                        </li>
                                    </ul>
                                    <h:panelGroup id="repositoryProps" layout="block">
                                        <section>
                                            <a4j:repeat value="#{designRepos}" var="designRepository">
                                                <div id="repo-#{designRepository.id}">
                                                    <table>
                                                        <tr>
                                                            <td>
                                                                <h:panelGrid id="designInfoPanel" columns="2"
                                                                             columnClasses="titleColumn">
                                                                    <h:outputText value="Name:"/>
                                                                    <h:inputText value="#{designRepository.name}" maxlength="20" onchange="updateRepoTab('#{designRepository.id}', this)"/>
                                                                    <h:outputText value="Type:"/>
                                                                    <h:selectOneMenu value="#{designRepository.type}">
                                                                        <f:ajax event="change"
                                                                                render="designParameters deployConfigFolderStructureParams designRepoTypeMessage"/>
                                                                <f:selectItem itemValue="repo-jdbc"
                                                                                      itemLabel="Database (JDBC)"/>
                                                                <f:selectItem itemValue="repo-jndi"
                                                                                      itemLabel="Database (JNDI)"/>
                                                                <f:selectItem itemValue="repo-aws-s3" itemLabel="AWS S3"/>
                                                                <f:selectItem itemValue="repo-azure-blob" itemLabel="Azure Blob Storage"/>
                                                                <f:selectItem itemValue="repo-git" itemLabel="Git"/>
                                                                    </h:selectOneMenu>
                                                                    <h:outputText value=""/>
                                                                    <h:panelGroup id="designRepoTypeMessage">
                                                                        <h:outputText value="#{designRepository.errorMessage}"
                                                                                      rendered="#{not empty designRepository.errorMessage}"
                                                                                      styleClass="error"/>
                                                                    </h:panelGroup>
                                                                </h:panelGrid>
                                                                <h:panelGroup id="designParameters">
                                                                    <h:panelGroup
                                                                    rendered="#{designRepository.type == 'repo-jdbc' or designRepository.type == 'repo-jndi'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/commonRepositorySettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{designRepository}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                    rendered="#{designRepository.type == 'repo-aws-s3'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/AWSS3RepositorySettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{designRepository}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                    rendered="#{designRepository.type == 'repo-azure-blob'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/AzureBlobRepositorySettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{designRepository}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                    rendered="#{designRepository.type == 'repo-git'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/GitRepositorySettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{designRepository}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>

                                                                    <h:panelGroup
                                                                            rendered="#{designRepository.folderRepository}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/folderStructureSettings.xhtml">
                                                                            <ui:param name="prependId" value="design"/>
                                                                            <ui:param name="settings"
                                                                                      value="#{systemSettingsBean.getFolderStructure(designRepository)}"/>
                                                                            <ui:param name="repoType" value="DESIGN"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                </h:panelGroup>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </a4j:repeat>
                                        </section>
                                        <ui:fragment rendered="#{not empty productionRepos}">
                                        <section>
                                            <c:set var="deployConfigRepo"
                                                   value="#{systemSettingsBean.deployConfigRepositoryConfiguration}"/>

                                            <div id="repo-deploy-config">
                                                <table>
                                                    <tr>
                                                        <td>
                                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                                <h:outputLabel value="Use Design Repository:"
                                                                               for="useDesignRepo"/>
                                                                <h:selectBooleanCheckbox id="useDesignRepo"
                                                                                         value="#{systemSettingsBean.useDesignRepo}"
                                                                                         title="Use Design Repository to store Deploy Configurations">
                                                                    <f:ajax event="change" render="deployConfigInfoPanel"/>
                                                                </h:selectBooleanCheckbox>
                                                            </h:panelGrid>
                                                            <h:panelGroup id="deployConfigInfoPanel">
                                                                <h:panelGrid columns="2" columnClasses="titleColumn">
                                                                    <h:outputText value="Repository:"
                                                                                  rendered="#{systemSettingsBean.useDesignRepo}"/>
                                                                    <h:selectOneMenu
                                                                            rendered="#{systemSettingsBean.useDesignRepo}"
                                                                            value="#{systemSettingsBean.designRepoForDeployConfig}">
                                                                        <f:selectItems
                                                                                value="#{systemSettingsBean.designRepositoryConfigurations}"
                                                                                var="repository"
                                                                                itemValue="#{repository.id}"
                                                                                itemLabel="#{repository.name}"/>
                                                                    </h:selectOneMenu>

                                                                    <h:outputText value="Name:"
                                                                                  rendered="#{not systemSettingsBean.useDesignRepo}"/>
                                                                    <h:inputText value="#{deployConfigRepo.name}"
                                                                                 disabled="true" maxlength="20"
                                                                                 rendered="#{not systemSettingsBean.useDesignRepo}"/>
                                                                    <h:outputText value="Type:"
                                                                                  rendered="#{not systemSettingsBean.useDesignRepo}"/>
                                                                    <h:selectOneMenu value="#{deployConfigRepo.type}"
                                                                                     rendered="#{not systemSettingsBean.useDesignRepo}">
                                                                        <f:ajax event="change"
                                                                                render="deployConfigParameters deployConfigFolderStructureParams deployConfigRepoTypeMessage"/>
                                                                    <f:selectItem itemValue="repo-jdbc"
                                                                                      itemLabel="Database (JDBC)"/>
                                                                    <f:selectItem itemValue="repo-jndi"
                                                                                      itemLabel="Database (JNDI)"/>
                                                                    <f:selectItem itemValue="repo-aws-s3"
                                                                                      itemLabel="AWS S3"/>
                                                                    <f:selectItem itemValue="repo-azure-blob"
                                                                                      itemLabel="Azure Blob Storage"/>
                                                                    <f:selectItem itemValue="repo-git" itemLabel="Git"/>
                                                                    </h:selectOneMenu>
                                                                    <h:outputText value=""/>
                                                                    <h:panelGroup id="deployConfigRepoTypeMessage">
                                                                        <h:outputText
                                                                                value="#{deployConfigRepo.errorMessage}"
                                                                                rendered="#{not systemSettingsBean.useDesignRepo and not empty deployConfigRepo.errorMessage}"
                                                                                styleClass="error"/>
                                                                    </h:panelGroup>
                                                                </h:panelGrid>
                                                                <h:panelGroup id="deployConfigParameters"
                                                                              rendered="#{not systemSettingsBean.useDesignRepo}">
                                                                    <h:panelGroup
                                                                        rendered="#{deployConfigRepo.type == 'repo-jdbc' or deployConfigRepo.type == 'repo-jndi'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/commonRepositorySettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{deployConfigRepo}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                        rendered="#{deployConfigRepo.type == 'repo-aws-s3'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/AWSS3RepositorySettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{deployConfigRepo}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                        rendered="#{deployConfigRepo.type == 'repo-azure-blob'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/AzureBlobRepositorySettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{deployConfigRepo}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                    <h:panelGroup
                                                                        rendered="#{deployConfigRepo.type == 'repo-git'}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/GitRepositorySettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="repository"
                                                                                      value="#{deployConfigRepo}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                </h:panelGroup>
                                                                <h:panelGroup id="deployConfigFolderStructureParams">
                                                                    <h:panelGroup
                                                                            rendered="#{systemSettingsBean.useDesignRepo ? designRepository.folderRepository : deployConfigRepo.folderRepository}">
                                                                        <ui:include
                                                                                src="/pages/modules/administration/settings/folderStructureSettings.xhtml">
                                                                            <ui:param name="prependId"
                                                                                      value="deployConfig"/>
                                                                            <ui:param name="settings"
                                                                                      value="#{systemSettingsBean.deployConfigFolderStructure}"/>
                                                                            <ui:param name="repoType"
                                                                                      value="DEPLOY_CONFIGURATION"/>
                                                                        </ui:include>
                                                                    </h:panelGroup>
                                                                </h:panelGroup>
                                                            </h:panelGroup>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </section>
                                        </ui:fragment>

                                        <section>
                                            <div class="repositoryConfig">
                                                <ui:param name="productionRepos"
                                                          value="#{systemSettingsBean.productionRepositoryConfigurations}"/>
                                                <a4j:repeat value="#{productionRepos}" var="repository">
                                                    <div id="repo-#{repository.id}">
                                                        <table>
                                                            <tr>
                                                                <td>
                                                                    <h:panelGrid id="repoInfoPanel" columns="2"
                                                                                 columnClasses="titleColumn">
                                                                        <h:outputText value="Name:"/>
                                                                        <h:inputText value="#{repository.name}"
                                                                                     styleClass="no-autocomplete" maxlength="20"
                                                                                     onchange="updateRepoTab('#{repository.id}', this)"/>
                                                                        <h:outputText value="Type:"/>
                                                                        <h:selectOneMenu value="#{repository.type}">
                                                                            <f:ajax event="change"
                                                                                    render="productionParameters"/>
                                                                        <f:selectItem itemValue="repo-jdbc"
                                                                                          itemLabel="Database (JDBC)"/>
                                                                        <f:selectItem itemValue="repo-jndi"
                                                                                          itemLabel="Database (JNDI)"/>
                                                                        <f:selectItem itemValue="repo-aws-s3"
                                                                                          itemLabel="AWS S3"/>
                                                                        <f:selectItem itemValue="repo-azure-blob"
                                                                                          itemLabel="Azure Blob Storage"/>
                                                                        <f:selectItem itemValue="repo-git" itemLabel="Git"/>
                                                                        <f:selectItem itemValue="repo-file" itemLabel="Local"/>
                                                                        </h:selectOneMenu>
                                                                    </h:panelGrid>
                                                                    <h:panelGroup id="productionParameters">
                                                                        <h:panelGroup
                                                                            rendered="#{repository.type == 'repo-jdbc' or repository.type == 'repo-jndi'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/commonRepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                        <h:panelGroup
                                                                            rendered="#{repository.type == 'repo-aws-s3'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/AWSS3RepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                        <h:panelGroup
                                                                            rendered="#{repository.type == 'repo-azure-blob'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/AzureBlobRepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                        <h:panelGroup
                                                                            rendered="#{repository.type == 'repo-git'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/GitRepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                        <h:panelGroup
                                                                            rendered="#{repository.type == 'repo-file'}">
                                                                            <ui:include
                                                                                    src="/pages/modules/administration/settings/LocalRepositorySettings.xhtml">
                                                                                <ui:param name="prependId"
                                                                                          value="production"/>
                                                                                <ui:param name="repository"
                                                                                          value="#{repository}"/>
                                                                                <ui:param name="repoType"
                                                                                          value="PRODUCTION"/>
                                                                                <ui:param name="isEditing" value="true"/>
                                                                            </ui:include>
                                                                        </h:panelGroup>
                                                                    </h:panelGroup>
                                                                    <h:panelGrid columns="2" columnClasses="titleColumn">
                                                                        <h:outputText value="Deployment Branch:"/>
                                                                        <h:selectOneMenu value="#{repository.settings.mainBranchOnly}">
                                                                            <f:selectItem itemValue="false" itemLabel="Any Branch"/>
                                                                            <f:selectItem itemValue="true" itemLabel="Main Branch Only"/>
                                                                        </h:selectOneMenu>
                                                                    </h:panelGrid>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </a4j:repeat>
                                            </div>

                                        </section>
                                    </h:panelGroup>
                                </div>
                                </h:panelGroup>
                                <h:panelGroup styleClass="button-panel" layout="block">
                                    <a4j:commandButton value="${applyButtonText}" action="#{systemSettingsBean.applyChanges}"
                                                       render="commonProps repoSettings javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       oncomplete="initSettingsPage();"
                                                       styleClass="button-primary" title="${applyButtonTitle}"/>
                                </h:panelGroup>
                            </div>
                            <div id="system">
                                <h:panelGroup id="javaProps" styleClass="fields" layout="block">
                                    <section>
                                        <h3>Core</h3>
                                        <div>
                                            <h:panelGrid columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Dispatching Validation:"/>
                                                <h:selectBooleanCheckbox
                                                        value="#{systemSettingsBean.dispatchingValidationEnabled}"
                                                        title="Turn on/off the Dispatching Validation feature"/>
                                                <h:outputText value="Verify on Edit:"/>
                                                <h:selectBooleanCheckbox value="#{systemSettingsBean.autoCompile}"
                                                                         title="Turn on/off verification on edit"/>
                                            </h:panelGrid>
                                        </div>
                                    </section>
                                    <section>
                                        <h3>Testing</h3>
                                        <div>
                                            <h:panelGrid id="testRunThreadCount" columns="2" columnClasses="titleColumn">
                                                <h:outputText value="Thread number for tests:"/>
                                                <h:inputText id="test-nThreads"
                                                             value="#{systemSettingsBean.testRunThreadCount}"
                                                             validator="#{validator.testRunThreadCountValidator}"/>
                                            </h:panelGrid>
                                            <h:message for="test-nThreads" class="error"/>
                                        </div>
                                    </section>
                                    <section>
                                        <h3>OpenL Studio Settings</h3>
                                        <div>
                                            <p>
                                                <h:graphicImage value="/images/warning.svg" alt="warning" style="height: 11px;"/>
                                                <span class="attention-text">WARNING!</span> If you click this button,
                                                all settings will be restored to default values. All user defined values,
                                                such as repository settings, will be lost. Use this button only if you
                                                understand the consequences.
                                            </p>

                                            <a4j:commandButton value="Restore Defaults and Restart"
                                                               action="#{systemSettingsBean.restoreDefaults}"
                                                               styleClass="restore-defaults-button"
                                                               execute="@this"
                                                               render="commonProps repositoryProps javaProps restartMessage"
                                                               onclick="return confirmSave();"
                                                               title="Restore the default settings"/>

                                        </div>
                                    </section>
                                </h:panelGroup>
                                <h:panelGroup styleClass="button-panel" layout="block">
                                    <a4j:commandButton value="${applyButtonText}" action="#{systemSettingsBean.applyChanges}"
                                                       render="commonProps repositoryProps javaProps restartMessage"
                                                       onclick="return confirmSave();"
                                                       styleClass="button-primary" title="${applyButtonTitle}"/>
                                </h:panelGroup>
                            </div>
                        </h:form>

                        <c:if test="#{isNotSingleMode}">
                            <div id="users" class="fields">
                                <ui:include src="/pages/modules/administration/users/users.xhtml"/>
                            </div>
                            <div id="groups" class="fields">
                                <ui:include src="/pages/modules/administration/settings/groupsSettings.xhtml"/>
                                <ui:include src="/pages/modules/administration/users/groups.xhtml"/>
                            </div>
                        </c:if>
                        <div id="notification" class="fields">
                            <section>
                                <h3>Notify all active users</h3>
                                <div>
                                    <table>
                                        <tbody>
                                        <tr>
                                            <td class="titleColumn">Message:</td>
                                            <td><textarea style="height:50px; resize: none" maxlength="250"/></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                            <input type="button" title="Post a message" value="Post"/>
                            <input type="button" title="Remove a message" value="Remove"/>
                        </div>
                        <div id="tags" class="fields">
                            <ui:include src="/pages/modules/administration/settings/tags/tagsConfig.xhtml"/>
                        </div>
                        <div id="mail" class="fields">
                            <ui:include src="/pages/modules/administration/settings/mail/mailConfig.xhtml"/>
                        </div>
                    </div>
                </div>

                <ui:include src="/pages/modules/showInfo.xhtml"/>
            </div>
        </div>

    </ui:define>
</ui:composition>
