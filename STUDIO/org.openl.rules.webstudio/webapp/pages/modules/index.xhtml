<!DOCTYPE html>
<html
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:oh="http://openl-tablets.sf.net/jsf/html"
    xmlns:rich="http://richfaces.org/rich">

    <c:set var="contextPath" value="#{facesContext.externalContext.request.contextPath}" />
    <c:set var="pathRoot" value="#{contextPath}/faces/pages/modules" />

<h:head>
    #{mainBean.init}

    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <link href="#{contextPath}/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
    <link href="#{contextPath}/css/bootstrap.min.css" rel="stylesheet" />
    <link href="#{contextPath}/css/common.css?10" rel="stylesheet" />
    <link href="#{contextPath}/css/layout/main.css" rel="stylesheet" />
    <link href="#{contextPath}/css/jquery.popup.css" rel="stylesheet" />
    <link href="#{contextPath}/css/jquery.multiselect.css" rel="stylesheet" />
    <link href="#{contextPath}/css/rulesDependencies.css" rel="stylesheet" />
    <link href="#{contextPath}/css/jquery-editable-select.min.css" rel="stylesheet" />

    <link href="#{contextPath}/webresource/css/tableeditor.min.css" rel="stylesheet" />

    <script src="#{contextPath}/javascript/common.js?12"></script>   <!-- increment parameter when js file is changed to force browser to reload cached file -->
    <script src="#{contextPath}/javascript/vendor/jquery-3.7.1.min.js"></script>
    <script src="#{contextPath}/javascript/vendor/jquery-migrate-3.4.1.min.js"></script>
    <script src="#{contextPath}/javascript/vendor/jquery-back-compat.js"></script>
    <script src="#{contextPath}/javascript/vendor/jquery.are-you-sure.js"></script>
    <script src="#{contextPath}/javascript/vendor/bootstrap.min.js"></script>
    <script src="#{contextPath}/javascript/vendor/signals.min.js"></script>
    <script src="#{contextPath}/javascript/vendor/crossroads.min.js"></script>
    <script src="#{contextPath}/javascript/vendor/jquery-ui-1.13.2.min.js"></script>
    <script src="#{contextPath}/javascript/vendor/jquery.layout.js?1"></script>
    <script src="#{contextPath}/javascript/jquery.popup.js"></script>
    <script src="#{contextPath}/javascript/jquery.multiselect.js?1"></script>
    <script src="#{contextPath}/javascript/bomjs.js"></script>
    <script src="#{contextPath}/javascript/vendor/response-monitor.js"></script>
    <script src="#{contextPath}/javascript/vendor/jquery-editable-select.min.js?1"></script>

    <h:outputScript name="jsf.js" library="javax.faces" />

    <script>
        //<![CDATA[
        var $j = $.noConflict();

        // TODO Move to external file
        // TODO Remove contextPath dependency
        var WebStudio = function() {

            var $ = jQuery;

            // Init

            var reqs = 0;
            var lastSavedHash = $location.getHash();
            var fullreload = false;
            var projectPageChanged = false;

            var urlRewrite = {
                prefix: "#{pathRoot}/"
            };

            var DEFAULT_CONTENT = {
                left:    { target: "#leftContent",   url: urlRewrite.prefix +  "leftPanel.xhtml" },
                top:     { target: "#top",           url: urlRewrite.prefix +  "topPanel.xhtml" },
                bottom:  { target: "#bottomContent", url: urlRewrite.prefix +  "bottomPanel.xhtml" },
                right:   { target: "#rightContent",  url: urlRewrite.prefix +  "rightPanel.xhtml" },
                content: { target: "#content",       url: urlRewrite.prefix +  "home.xhtml" }
            };

            var WS_PANEL_STATE_VAR = "WS_PANEL_STATE";
            var WS_PREVIOUS_PAGE_STATE_VAR = "WS_PREVIOUS_PAGE_STATE";

            var current  = {
                repositoryId: 0,
                project: 0,
                module: 0,
                branch: 0
            };

            var loadingPanel;
            var mainLayout;
            var centerLayout;

            var requestId = null;

            var ChangesListener = function () {
                // Private members
                var self = this;
                var hasChanges = function() {return false};
                var showConfirmDialog = function() {};

                var rollbackChanges = function () {};

                // Public members
                this.revertChanges = function() {
                    if (hasChanges()) {
                        rollbackChanges();
                    }
                };

                this.applyCurrentChanges = function () {};

                this.configure = function (project) {
                    var empty = function () {};

                    hasChanges = project.isHasChanges || empty;
                    showConfirmDialog = project.showConfirmDialog || empty;
                    rollbackChanges = project.rollbackChanges || empty;
                    this.applyCurrentChanges = project.applyCurrentChanges || empty;

                    window.onbeforeunload = function (e) {
                        var changed = hasChanges();
                        if (changed) {
                            return 'Table is not saved. If you leave this page, all changes will be lost.';
                        }
                    };
                };

                this.checkForChanges = function(proceed, revertUrlChange, retryUrlChange) {
                    if (typeof revertUrlChange == "undefined") {
                        revertUrlChange = function() {};
                    }
                    if (typeof retryUrlChange == "undefined") {
                        retryUrlChange = function () {
                            // We are here after changes were reverted on server side. Need to refresh table and proceed.
                            api.nav.reload();
                            proceed();
                        };
                    }
                    if (hasChanges()) {
                        revertUrlChange();

                        var revertAndProceed = function () {
                            self.revertChanges();
                            retryUrlChange();
                        };
                        showConfirmDialog(revertAndProceed);
                        return true;
                    } else {
                        proceed();
                        return false;
                    }
                };

                this.addChangesListener = function(selector) {
                    $(selector).each(function() {
                        var $a = $(this);

                        var onClickFunc = new Function("event", $a.attr("onclick"));
                        $a.removeAttr('onclick').off('click');
                        $a.click(function (e) {
                            if (e.which != 2) {
                                // Not a middle mouse button
                                var proceed = function () {
                                    var result = onClickFunc(e);
                                    if (typeof result == "undefined" || result) {
                                        var href = $a.attr("href");
                                        href && $location.set(href);
                                    }
                                };
                                api.changes.applyCurrentChanges();
                                api.changes.checkForChanges(proceed);
                                e.preventDefault();
                            }
                        });
                    });
                };
            };

            // Public API

            var api = {
                ajax: {
                    get: function(urls, done, error) {
                        if (typeof urls === "string") {
                            // One page
                            jQuery.get(urls, function() {
                                done(arguments);
                            }).fail(function (response) {
                                if (error) {
                                    error(response);
                                }
                            });
                        } else {
                            // Few pages
                            var requests = [];
                            for (var i = 0; i < urls.length; i++) {
                                requests.push($.get(urls[i]));
                            }
                            $.when.apply($, requests).done(function() {
                                // After all pages are loaded
                                done(arguments);
                            });
                        }
                    },
                    load: function(parts, done) {
                        var urls = [];
                        for (var i = 0; i < parts.length; i++) {
                            urls.push(parts[i].url);
                        }
                        this.get(urls, function(result) {
                            if (parts.length == 1) {
                                $(parts[0].target).html(result[0]);
                            } else {
                                for (var i = 0; i < parts.length; i++) {
                                    $(parts[i].target).html(result[i][0]);
                                }
                            }
                            done && done();
                            fixRichFaces();
                        });
                    }
                },
                utils : {
                    escapeHtml: function (string) {
                        return $('<div/>').text(string).html();
                    }
                },
                storage: {
                    get: function(name) {
                        var strValue = localStorage.getItem(name);
                        return strValue ? JSON.parse(strValue) : null;
                    },
                    set: function(name, value) {
                        localStorage.setItem(name, JSON.stringify(value));
                    }
                },

                nav: {
                    home: function() {
                        crossroads.parse("/", ["false"]);
                    },
                    reload: function(args) {
                        // Reload all page (if args is true) or only content
                        if (typeof args == "boolean") {
                            loadContent("", args);
                            // Reload only content with new params
                        } else if (typeof args == "object") {
                            var currentPage = getCurrentPage();
                            var newPage = $location.utils.setParams(currentPage, args);
                            api.nav.go(newPage);
                            // Reload only content
                        } else {
                            loadContent();
                        }
                    },
                    reloadPanel: function(panel, callback) {
                        if (panel == "left") {
                            let isHistoryPanel = $('#recentVisitedTablesPanel').is(":visible");
                            let expandedNodes = getExpandedNodes();
                            let expandAndCallback = () => {
                                expandNodes(expandedNodes);

                                if (callback) {
                                    callback();
                                } else {
                                    if (isHistoryPanel) {
                                        $("#rulesTreePanel").hide();
                                        $("#recentVisitedTablesPanel").show();
                                    } else {
                                        openTreeNode();
                                    }
                                }
                            }
                            api.ajax.load([DEFAULT_CONTENT.left], expandAndCallback);
                        }
                    },
                    openHistoryPanel: function() {
                        api.nav.reloadPanel("left", function() {
                            $("#projectsTreePanel").hide();
                            $("#rulesTreePanel").hide();
                            $("#recentVisitedTablesPanel").show();
                        });
                    },
                    closeHistoryPanel: function() {
                        openTreeNode();
                        $("#projectsTreePanel").hide();
                        $("#rulesTreePanel").show();
                        $("#recentVisitedTablesPanel").hide();
                    },
                    go: function(page, reload) {
                        if (page) {
                            page = page.replace(urlRewrite.prefix, "");
                            // Check if requested page is the same as current
                            if (decodeURIComponent(page.replace(/^#/, '')) == $location.getHash(true)) {
                                loadContent('', reload);
                            } else {
                                fullreload = reload;
                                location.hash = page;
                            }
                        }
                    },
                    download: function (url) {
                        var options = {
                            timeout: 120, // seconds
                            interval: 100, // milliseconds
                            onRequest: function (token) {
                                api.ui.showLoader();
                            },
                            onResponse: function (status) {
                                if (downloadPage.isOpened()) {
                                    downloadPage.close();
                                } else {
                                    api.ui.hideLoader();
                                }
                                if (status !== "success") {
                                    api.ui.info(status);
                                }
                            },
                            onTimeout: function () {
                                api.ui.hideLoader();
                                api.ui.info('File generation was aborted');
                                if (downloadPage.isOpened()) {
                                    downloadPage.close();
                                }
                            },
                            onMonitor: function (countdown) {
                                if (countdown === 0) {
                                    var countdownsForSecond = 1000 / options.interval;
                                    // Before timeout. Continue waiting, otherwise download will be cancelled.
                                    monitor.countdown = countdownsForSecond;

                                    if (!downloadPage.isOpened()) {
                                        downloadPage.open({
                                            onWait: function (seconds) {
                                                api.ui.showLoader();
                                                monitor.countdown = seconds * countdownsForSecond;
                                            },
                                            onAbort: function () {
                                                monitor.countdown = -1;
                                            }
                                        });

                                        // Make dialog accessible
                                        api.ui.hideLoader();
                                    }
                                }
                            }
                        };

                        var monitor = new ResponseMonitor(url, options);
                        monitor.execute();
                    },
                    // prefixPage will be removed when Global Search will be implemented
                    search: function(params, prefixPage) {
                        var query;

                        if (params) {
                            // Simple Search by text
                            if (params.constructor === String) {
                                query = "query=" + encodeURIComponent(params);

                                // Advanced Search
                            } else {
                                query = $.param(params);
                            }
                        }

                        if (prefixPage.length > 0 && prefixPage.substr(-1) !== '/') {
                            prefixPage += '/';
                        }

                        api.nav.go(prefixPage + "search" + (query ? "?" + query : ""));
                    },
                    isProjectChanged: function () {
                        return projectPageChanged;
                    },
                    setRequestId: function (newRequestId) {
                        api.nav.unloadPage();
                        requestId = newRequestId;
                    },
                    unloadPage: function() {
                        // Search all visible popup panels in the page and hide them
                        $j('.rf-pp-cntr:visible').each(function() {
                            let id = $j(this).attr('id');
                            let suffix = '_container';
                            if (id && id.endsWith(suffix)) {
                                api.ui.hide(id.substring(0, id.length - suffix.length));
                            }
                        });

                        if (requestId !== null && requestId !== '') {
                            onPageUnload(requestId);
                            requestId = null;
                        }
                    }
                },

                ui: {
                    show: function(id, params) {
                        // RichFaces Popup
                        if ($("#" + id + "_container").length) {
                            RichFaces.$(id).show();

                            if (!params || (params && params.focus !== false)) {
                                // Focus the first visible enabled input
                                $("#" + id + "_container :input:enabled:visible:first").focus();
                            }
                        }
                    },
                    hide: function(id) {
                        // RichFaces Popup
                        if ($("#" + id + "_container").length) {
                            RichFaces.$(id).hide();
                        }
                    },
                    // TODO Merge with 'show' method
                    showPopupMenu: function(event, popupId, elem, params) {
                        var elem = $(elem);
                        var elemPos = elem.position();

                        var left = elemPos.left + ((params && params.offsetLeft) || 0);
                        var top = elemPos.top + elem.outerHeight() + ((params && params.offsetTop) || 0);
                        var closeIcon = (params && params.closeIcon && 'webresource/images/close.gif') || false;

                        var popupParams = {
                            caller   : event.target,
                            left     : left,
                            top      : top,
                            closeIcon: closeIcon
                        };
                        if (params && params.fitToScreen === true) {
                            popupParams.maxWidth = "calc(100% - " + left + "px)";
                            popupParams.maxHeight = "calc(100% - " + top + "px)";
                        }

                        $("#" + popupId).popup(popupParams);
                    },
                    confirm: function (options) {
                        let confirmPopup = RichFaces.$('confirmPopup');

                        const defaults = {
                            title: 'Confirm',
                            message: 'Are you sure?',
                            okButton: 'OK',
                            cancelButton: 'Cancel',
                            onOK: () => {},
                            onCancel: () => {},
                        };
                        options = $.extend({}, defaults, options);

                        $('#confirmPopupTitle').text(options.title);
                        $('#confirmPopupMessage').text(options.message);
                        $('#confirmPopupOkButton').val(options.okButton).off().click(() => {
                            options.onOK();
                            confirmPopup.hide();
                        });
                        $('#confirmPopupCancelButton').val(options.cancelButton).off().click(() => {
                            options.onCancel();
                            confirmPopup.hide();
                        });

                        confirmPopup.show();
                    },
                    showLoader: function () {
                        if (reqs++ == 0) {
                            showAnimatedPanel(loadingPanel);
                        }
                    },
                    hideLoader: function () {
                        if (reqs-- == 1) {
                            loadingPanel.hide();
                        }
                        if (reqs < 0) {
                            reqs = 0;
                            console.warn('hideLoader() without showLoader() is called.');
                        }
                    },
                    success: function(content) {
                        message(content, 4000, true, "success");
                    },
                    error: function(content) {
                        message(content, -1, true, "error");
                    },
                    info: function(content) {
                        message(content, 8000, true);
                    },

                    problems: {
                        show: function() {
                            centerLayout.show("south");
                        },
                        hide: function() {
                            centerLayout.hide("south");
                        }
                    }
                },

                changes: new ChangesListener()
            };

            (function initUI() {
                $(function () {

                    function changePanelState(panel, obj, state) {
                        var panelState = ws.storage.get(WS_PANEL_STATE_VAR);
                        panel === "west"  && (panelState.left   = !state.isClosed);
                        panel === "east"  && (panelState.right  = !state.isClosed);
                        panel === "south" && (panelState.bottom = !state.isClosed);
                        ws.storage.set(WS_PANEL_STATE_VAR, panelState);
                    }

                    mainLayout = $("#center").layout({
                        spacing_open: 1,
                        spacing_closed: 17,
                        minSize: 209,
                        west__size: 235,
                        east__size: 235,
                        east__initHidden: true,
                        slidable: false,
                        enableCursorHotkey: false,
                        onopen: changePanelState,
                        onclose: changePanelState
                    });
                    mainLayout.addCloseBtn("#west-closer", "west");
                    mainLayout.addCloseBtn("#east-closer", "east");

                    centerLayout = $("#center .ui-layout-center").layout({
                        spacing_open: 1,
                        spacing_closed: 17,
                        minSize: 57,
                        south__size: 110,
                        south__initHidden: true,
                        slidable: false,
                        enableCursorHotkey: false,
                        onopen: changePanelState,
                        onclose: changePanelState
                    });
                    centerLayout.addCloseBtn("#south-closer", "south");

                    loadingPanel = $("#loadingPanel");

                    var panelState = ws.storage.get(WS_PANEL_STATE_VAR);
                    if (!panelState) {
                        ws.storage.set(WS_PANEL_STATE_VAR, {
                            left: true,
                            right: true,
                            bottom: true
                        });
                    } else {
                        panelState.left === false && mainLayout.close("west");
                        panelState.right === false && mainLayout.close("east");
                        panelState.bottom === false && centerLayout.close("south");
                    }

                    loadContent();

                    $j(window).on('unload', function () {
                        api.nav.unloadPage();
                    });

                    $("body").css({"visibility": "visible"});
                });
            })();

            (function initNavigation() {
                $.ajaxSetup({
                    handleLoginPage: true,
                    cache: false,
                    beforeSend: api.ui.showLoader,
                    // Handle jQuery AJAX errors
                    error: function(response, message, error) {
                        handleError(response.status, response.responseText);
                    },
                    complete: api.ui.hideLoader
                });

                $.ajaxPrefilter(function(options, _, jqXHR) {
                    if (options.handleLoginPage) {
                        var deferredRequest = $.Deferred();

                        jqXHR.done(
                                function (data) {
                                    if (typeof(data) == "string" && data.indexOf("OPENL_LOGIN_PAGE") != -1) {
                                        location.href = "#{contextPath}/faces/pages/sessionExpired.xhtml";
                                    } else {
                                        deferredRequest.resolveWith(this, arguments);
                                    }
                                }
                        );

                        deferredRequest.promise(jqXHR);

                        jqXHR.success = jqXHR.done;
                    }
                });

                // Fix Mojarra bug. Make rerendered forms work.
                // See http://java.net/jira/browse/JAVASERVERFACES_SPEC_PUBLIC-790
                jsf.ajax.addOnEvent(function (data) {
                    if (data.status === "success") {
                        var viewState = $("partial-response:first changes:first update[id = 'javax.faces.ViewState']", data.responseXML);
                        if (viewState.length) {
                            $("partial-response:first changes:first update[id != 'javax.faces.ViewState']", data.responseXML).each(function (i, u) {
                                $("form", document.getElementById(u.getAttribute("id"))).each(function (i, f) {
                                    var field = $("input[name='javax.faces.ViewState']", f);
                                    if (!field.length) {
                                        field = $("<input type=\"hidden\" name=\"javax.faces.ViewState\" />").appendTo(f);
                                    }
                                    field.val(viewState.text());
                                });
                            });
                        }
                    }
                });

                // Handle JSF / Richfaces AJAX errors
                jsf.ajax.addOnError(function (data) {
                    if (typeof console != "undefined") console.error(data);

                    // @Deprecated
                    var errorMessage = data.errorMessage;
                    if (errorMessage) {
                        // TODO Create mechanism to disable editing in UI when Excel file is opened.
                        if (data.errorName && data.errorName.indexOf("ViewExpiredException") > -1) {
                            api.nav.reload(true);
                        } else {
                            api.ui.info(errorMessage);
                        }
                        return;
                    }
                    handleError(data.responseCode);
                });

                $(window).bind("hashchange", function() {
                    var ch = $location.getHash();
                    if (ch != lastSavedHash && ch == decodeURIComponent(lastSavedHash)) {
                        // Workaround for a bug in firefox.
                        // Sometimes it decodes a loading url and then loads decoded url.
                        location.hash = lastSavedHash;
                        return;
                    } else {
                        if (ch == lastSavedHash) {
                            return;
                        }
                        var proceed = function() {
                            lastSavedHash = ch;
                            loadContent(getCurrentPage(), fullreload);
                            fullreload = false;
                            api.nav.unloadPage();
                        };
                        var retry = function() {
                            $location.setHash(ch);
                        };
                        var revert = function() {
                            $location.setHash(lastSavedHash);
                        };

                        api.changes.checkForChanges(proceed, revert, retry);
                    }
                });
            })();

            (function initRouter() {
                var determineIfModuleChanged = function (repositoryId, project, module) {
                    var previousPageState = ws.storage.get(WS_PREVIOUS_PAGE_STATE_VAR);
                    if (!previousPageState) {
                        previousPageState = {
                            repositoryId: "",
                            project: "",
                            module: ""
                        };
                    }
                    projectPageChanged = previousPageState.repositoryId !== repositoryId
                        || previousPageState.project !== project
                        || previousPageState.module !== module;
                    var pageState = {
                        repositoryId: repositoryId,
                        project: project,
                        module: module
                    };
                    ws.storage.set(WS_PREVIOUS_PAGE_STATE_VAR, pageState);
                };

                crossroads.ignoreState = true;

                // Home page
                crossroads.addRoute("/", function(reload) {
                    var toReload = { top: 1, left: 1, bottom: 0, right: 0 };
                    var toOpen = { bottom: 0, right: 0 };
                    determineIfModuleChanged("", "", "");
                    render("home.xhtml", 0, toReload, toOpen);
                });
                // Project page
                crossroads.addRoute("{repositoryId}/{project}", function(reload, repositoryId, project) {
                    var url = "project.xhtml?repositoryId=" + repositoryId + "&name=" + project;
                    setModule(repositoryId, project);
                    var leftReload = reload == "true" || !$("#projects-tree").length;
                    var toReload = { top: 1, left: leftReload, bottom: 0, right: 0 };
                    var toOpen = { bottom: 0, right: 0 };
                    determineIfModuleChanged(repositoryId, project, "");
                    render(url, { repositoryId: repositoryId, project: project }, toReload, toOpen, openProjectNode);
                });
                // Project-specific additional info pages
                crossroads.addRoute("{repositoryId}/{project}?page={page}&:{query}:", function(reload, repositoryId, project, page, query) {
                    let url = page + ".xhtml";
                    if (query) {
                        url += "?" + query;
                    }
                    setModule(repositoryId, project);
                    let leftReload = reload === "true" || !$("#projects-tree").length;
                    let toReload = {top: 1, left: leftReload, bottom: 0, right: 0};
                    let toOpen = {bottom: 0, right: 0};
                    determineIfModuleChanged(repositoryId, project, "");
                    render(url, { repositoryId: repositoryId, project: project }, toReload, toOpen, openProjectNode);
                });
                // Project with branch page
                crossroads.addRoute("{repositoryId}/{project}/[{branch}]", function(reload, repositoryId, project, branch) {
                    var url = "project.xhtml?repositoryId=" + repositoryId + "&name=" + project;
                    var branchChanged = current.branch !== branch;
                    setModule(repositoryId, project, undefined, branch);
                    var leftReload = reload == "true" || !$("#projects-tree").length || branchChanged;
                    var toReload = { top: 1, left: leftReload, bottom: 0, right: 0 };
                    var toOpen = { bottom: 0, right: 0 };
                    determineIfModuleChanged(repositoryId, project, "");
                    render(url, { repositoryId: repositoryId, branch: branch, project: project }, toReload, toOpen, openProjectNode);
                });
                // Module page
                crossroads.addRoute("{repositoryId}/{project}/{module}", function(reload, repositoryId, project, module) {
                    var url = "module.xhtml?repositoryId=" + repositoryId + "&project=" + project + "&name=" + module;
                    var newModule = setModule(repositoryId, project, module);
                    var topReload =  reload == "true" || !$("#breadcrumbs-module").length || newModule;
                    var leftReload = reload == "true" || !$("#rulesTree").length || newModule;
                    var bottomReload = reload == "true" || !$("#bottomPanel").length || newModule;
                    var toReload = { top: topReload, left: leftReload, bottom: bottomReload, right: 0 };
                    var toOpen = { bottom: 1, right: 0 };
                    determineIfModuleChanged(repositoryId, project, module);
                    render(url, { repositoryId: repositoryId, project: project, module: module }, toReload, toOpen);
                });
                // Table page
                crossroads.addRoute("{repositoryId}/{project}/{module}/table?{query}", function(reload, repositoryId, project, module, query) {
                    var url = [
                        { url: "table.xhtml?" + query },
                        { url: "tableDetailsData.xhtml?" + query, target: "#tableProperties" }
                    ];

                    //var toReload = !current.module || setModule(project, module);
                    var newModule = setModule(repositoryId, project, module);
                    var topReload =  reload == "true" || !$("#breadcrumbs-module").length || newModule;
                    var leftReload = reload == "true" || !$("#rulesTree").length || newModule;
                    var bottomReload = reload == "true" || !$("#bottomPanel").length || newModule;
                    var toReload = { top: topReload, left: leftReload, bottom: bottomReload, right: 1 };
                    var toOpen = { bottom: 1, right: 1 };
                    determineIfModuleChanged(repositoryId, project, module);
                    render(url, { repositoryId: repositoryId, project: project, module: module }, toReload, toOpen, openTreeNode);
                });
                // Other pages
                crossroads.addRoute("{repositoryId}/{project}/search?{query*}", function(reload, repositoryId, project, query) {
                    var url = "search.xhtml?" + query;
                    var newModule = setModule(repositoryId, project);
                    var topReload =  reload == "true" || !$("#breadcrumbs-module").length || newModule;
                    var leftReload = reload == "true" || !$("#projects-tree").length || newModule;
                    var bottomReload = reload == "true" || !$("#bottomPanel").length || newModule;
                    var toReload = { top: topReload, left: leftReload, bottom: bottomReload, right: 0 };
                    var toOpen = { bottom: 1, right: 0 };
                    determineIfModuleChanged(repositoryId, project, "");
                    render(url, { repositoryId: repositoryId, project: project }, toReload, toOpen, openProjectNode);
                });
                crossroads.addRoute("{repositoryId}/{project}/{module}/{page*}", function(reload, repositoryId, project, module, page) {
                    var query;
                    if (page.indexOf("?") > -1) {
                        var parts = page.split("?");
                        page = parts[0];
                        query = parts[1];
                    }
                    var url = page + ".xhtml" + (query ? ("?" + query) : "");
                    var newModule = setModule(repositoryId, project, module);
                    var topReload =  reload == "true" || !$("#breadcrumbs-module").length || newModule;
                    var leftReload = reload == "true" || !$("#rulesTree").length || newModule;
                    var bottomReload = reload == "true" || !$("#bottomPanel").length || newModule;
                    var toReload = { top: topReload, left: leftReload, bottom: bottomReload, right: 0 };
                    var toOpen = { bottom: 1, right: 0 };
                    determineIfModuleChanged(repositoryId, project, module);
                    render(url, { repositoryId: repositoryId, project: project, module: module }, toReload, toOpen);
                });
            })();


            // Private API

            var handleError = function(code, error) {
                if (code === 399) { // Session Timeout
                    location.href = "#{contextPath}/faces/pages/sessionExpired.xhtml";
                } else if (code !== 404 && code !== 0) { // 0 - timeout/abort
                    // 404 error is handled in other place. Other errors are unexpected errors
                    if (is4xxStatus(code)) {
                        let json = (function (rawJson) {
                            try {
                                return JSON.parse(rawJson);
                            } catch (e) {
                                return null;
                            }
                        })(error);
                        if (json?.message != null) {
                            api.ui.info(json.message);
                        } else {
                            api.ui.info("#{msg['ws.common.error.500']}");
                        }
                    } else {
                        api.ui.info("#{msg['ws.common.error.500']}");
                    }
                }
            };

            var getCurrentPage = function() {
                if (location.hash) {
                    var page = lastSavedHash;
                    if (page && page.indexOf(urlRewrite.prefix) < 0) {
                        page = urlRewrite.prefix + page;
                    }
                    return page;
                }
            };

            var loadContent = function(page, reload) {
                var page = page || getCurrentPage();

                if (!page) {
                    crossroads.parse("/", ["false"]);
                    return;
                }

                if (page.indexOf(urlRewrite.prefix) > -1) {
                    page = page.split(urlRewrite.prefix)[1];
                }

                var params = [reload ? "true" : "false"];
                crossroads.parse(page, params);
            };

            var setModule = function(repositoryId, project, module, branch) {
                var newModule = repositoryId && project && module
                        && (!current.module || (current.repositoryId && current.project && current.module
                        && (current.repositoryId !== repositoryId || current.project !== project || current.module !== module)));

                current.repositoryId = repositoryId || 0;
                current.project = project || 0;
                current.module = module || 0;
                current.branch = branch || 0;

                return newModule;
            };

            var render = function(page, init, load, open, done) {
                var content = [];
                var callbacks = [];

                load.left   && content.push(DEFAULT_CONTENT.left);
                load.top    && content.push(DEFAULT_CONTENT.top);
                load.bottom && content.push(DEFAULT_CONTENT.bottom);
                load.right  && content.push(DEFAULT_CONTENT.right);

                if (page) {
                    if (typeof page === "string") {
                        // One page
                        content.push({ target: DEFAULT_CONTENT.content.target, url: urlRewrite.prefix +  page });
                    } else {
                        // Few pages
                        for (var i = 0; i < page.length; i++) {
                            content.push(
                                    { target: (page[i].target || DEFAULT_CONTENT.content.target), url: urlRewrite.prefix +  page[i].url } );
                        }
                    }
                }

                callbacks.push(open.bottom ?
                        function() {
                            var opened = ws.storage.get(WS_PANEL_STATE_VAR).bottom;
                            centerLayout.show("south");
                            !opened && centerLayout.close("south");
                        } : function() {
                    centerLayout.hide("south");
                });
                callbacks.push(open.right ?
                        function() {
                            var opened = ws.storage.get(WS_PANEL_STATE_VAR).right;
                            mainLayout.show("east");
                            !opened && mainLayout.close("east");
                        }
                        : function() {
                            var state = ws.storage.get(WS_PANEL_STATE_VAR);
                            var opened = state.right;
                            mainLayout.hide("east");
                            if (opened) {
                                state.right = true;
                                ws.storage.set(WS_PANEL_STATE_VAR, state);
                            }
                });

                done && callbacks.push(done);

                callbacks.push(function() {
                    api.changes.addChangesListener(".changes-listener");
                    $(".changes-listener").toggleClass("changes-listener changes-listener-added");
                });

                callbacks.push(function () {
                    initPopupPanels();
                })

                callbacks.push(function(){
                    let compilationProgressObserver = null;
                    const layout = $j('.panel-header>.layout-extractable-info');
                    if (layout[0]) {
                        const callback = function() {
                            let layoutPane = layout.parents(".ui-layout-pane:first");
                            if (layoutPane) {
                                let layoutDirection =
                                    layoutPane.attr("class")
                                        .split(/\s+/)
                                        .find(function(e){return e.startsWith("ui-layout-pane-");})
                                        .split(/-/)[3];

                                let layoutToggler = layoutPane.siblings(".ui-layout-resizer-" + layoutDirection + ":first");
                                let extractedLayoutInfo = layoutToggler.find(".layout-extractable-info");
                                if (extractedLayoutInfo.length > 0) {
                                    extractedLayoutInfo.remove();
                                }
                                let cloned = layout.clone();
                                cloned.find("*").removeAttr("id");
                                cloned.appendTo(layoutToggler);
                            }
                        }
                        callback();
                        // Create an observer instance linked to the callback function
                        compilationProgressObserver = new MutationObserver(callback);
                        // Start observing the target node for configured mutations
                        compilationProgressObserver.observe(layout[0], {
                            childList: true,
                            subtree: true
                        });
                    }
                })

                var initUrl = urlRewrite.prefix + "init.xhtml";
                if (init && init.project) {
                    initUrl += ("?project=" + init.project);
                    initUrl += ("&repositoryId=" + init.repositoryId);
                    if (init.module) {
                        initUrl += "&module=" + init.module;
                    }
                    if (init.branch) {
                        initUrl += "&branch=" + init.branch;
                    }
                }

                api.ajax.get(initUrl, function () {
                        // Load all pages after project/module model initialized
                        api.ajax.load(content, function () {
                                for (var i = 0; i < callbacks.length; i++) {
                                    callbacks[i].call();
                                }
                            }
                        );
                    },
                    function (response) {
                        // Something gone wrong
                        if (response.status == 404) {
                            // Project or module is not found
                            ws.storage.set(WS_PREVIOUS_PAGE_STATE_VAR, {
                                repositoryId: init.repositoryId,
                                project: "",
                                module: ""
                            });
                            var notFoundUrl = urlRewrite.prefix + 'pageNotFound.xhtml';
                            if (init && init.project) {
                                notFoundUrl += ("?project=" + init.project);
                                notFoundUrl += ("&repositoryId=" + init.repositoryId);
                                if (init.module) {
                                    notFoundUrl += "&module=" + init.module;
                                }
                            }

                            var notFoundContent = [];
                            load.left   && notFoundContent.push(DEFAULT_CONTENT.left);
                            load.top    && notFoundContent.push(DEFAULT_CONTENT.top);
                            notFoundContent.push({ target: DEFAULT_CONTENT.content.target, url: notFoundUrl });

                            api.ajax.load(notFoundContent, function () {
                                $(DEFAULT_CONTENT.right.target).html('');

                                var state = ws.storage.get(WS_PANEL_STATE_VAR);
                                mainLayout.hide("east");
                                if (state.right) {
                                    ws.storage.set(WS_PANEL_STATE_VAR, state);
                                }

                                centerLayout.hide("south");
                                //Needed to open the project module tree if the project can be found
                                filterSpecificProject(decodeURIComponent(init.project));
                                fixRichFaces();
                            });
                        }
                    }
                );
            };

            let getExpandedNodes = function () {
                let $expanded = $("#rulesTree .rf-tr-nd-exp");
                let expandedNodes = [];
                $expanded.each(function () {
                    let hrefChildren = $(this).find("a").filter(function() {
                        return $(this).parents('.rf-tr-nd-colps').length === 0;
                    });
                    if (hrefChildren.length > 0) {
                        expandedNodes.push(hrefChildren.first().attr("href"));
                    }
                });

                return expandedNodes;
            }

            let expandNodes = function (expandedNodes) {
                for (const node of expandedNodes) {
                    let $node = $("#rulesTree a[href *= '" + node + "']");
                    $node.parents(".rf-tr-nd-colps").each(function () {
                        $(this).toggleClass("rf-tr-nd-colps rf-tr-nd-exp");
                        $(this).find(".rf-trn-hnd-colps:first").toggleClass("rf-trn-hnd-colps rf-trn-hnd-exp")
                    });
                }
            };

            var openTreeNode = function(pageToOpen) {
                var page = pageToOpen || getCurrentPage();

                if (page && page.indexOf("table?id=") > -1) {
                    var tableId = page.split("id=")[1].split("&")[0];
                    var tableLink = $("#rulesTree a[href *= '" + tableId + "']");

                    if (tableLink.length) { // Firefox has bug with decoding url after refresh
                        // Expand nodes
                        tableLink.parents(".rf-tr-nd-colps").each(function () {
                            var node = $(this);
                            node.toggleClass("rf-tr-nd-colps rf-tr-nd-exp");
                            node.find(".rf-trn-hnd-colps:first").toggleClass("rf-trn-hnd-colps rf-trn-hnd-exp");
                        });
                        // Select node
                        $("#rulesTree .rf-trn.sel").removeClass("sel");
                        tableLink.closest(".rf-trn").addClass("sel");

                        // Select the last used table in the history view
                        $("#historyTable a.selected-link").removeClass("selected-link");
                        $("#historyTable a[href *= '" + tableId + "']").addClass("selected-link");

                        var panelBody = tableLink.closest(".panel-body");
                        var linkPos = tableLink.position().top;
                        if (linkPos < 0 || linkPos > panelBody.height()) {
                            panelBody.animate({
                                scrollTop: tableLink.position().top + panelBody.scrollTop() - 7
                            });
                        }
                    }
                }
            };

            var openProjectNode = function(pageToOpen) {
                let page = pageToOpen || getCurrentPage();

                if (page && page.indexOf("modules/") > -1) {
                    let projectName = page.split("modules/")[1];
                    let queryIndex = projectName.indexOf("?");
                    if (queryIndex > -1) {
                        projectName = projectName.substring(0, queryIndex);
                    }
                    let repoEndIdx = projectName.indexOf("/");
                    let secondSlashIndex = projectName.substring(repoEndIdx + 1).indexOf("/");
                    if (secondSlashIndex >= 0) {
                        projectName = projectName.substring(0, repoEndIdx + secondSlashIndex + 1);
                    }
                    let repoId = projectName.substring(0, repoEndIdx);
                    projectName = projectName.substring(repoEndIdx + 1);

                    //remove branch from project name. To re-render project tree in correct way
                    let branchStartIdx = projectName.indexOf("/[");
                    if (branchStartIdx > -1) {
                        projectName = projectName.substring(0, branchStartIdx);
                    }
                    let projectLink = $("#projects-tree a[href = '#" + repoId + "/" + projectName + "']");
                    if (projectLink.length) { // Firefox has bug with decoding url after refresh
                        // Select node
                        filterSpecificProject(decodeURIComponent(projectName));
                    }
                }
            };

            return api;
        };

        var ws = new WebStudio();

        $j(function () {
            fixRichFaces();
            const needRedirect = #{studio.needRedirect};
            if (needRedirect) {
                ws.nav.go("#{studio.url()}", true);
            }
            setTimeout(checkModification, 10000); // Time in milliseconds
        });

        function checkModification() {
            var $jq1 = jQuery.noConflict();
            $jq1.ajax({
                url: "#{contextPath}/web/module/isModified",
                datatype: "text",
                timeout: 5000
            })
                .done(function (data) {
                    if (data === "true" && confirm('Project source file was modified.\nClick \'OK\' to reload OpenL Studio with changes, and \'Cancel\' to ignore changes.')) {
                        reloadModule(); // from the topPanel.xhtml
                    }
                })
                .always(function () {
                    setTimeout(checkModification, 5000)
                });
        }

    //]]>
    </script>

    <title>OpenL Studio</title>
</h:head>

<h:body style="visibility: hidden">
    <script src="#{contextPath}/webresource/js/prototype/prototype-1.7.3.js"></script>
    <script src="#{contextPath}/webresource/js/tableeditor.min.js?1"></script>

    <div id="header">
        <ui:include src="/pages/common/header.xhtml">
            <ui:param name="menu" value="rules" />
        </ui:include>
    </div>

    <div id="top"></div>

    <div id="center">
        <div id="left" class="ui-layout-west">
            <div id="leftContent"></div>
            <span id="west-closer" class="pane-closer" title="#{msg['ws.common.icon.close']}" />
        </div>
        <div class="ui-layout-center">
            <div id="content" class="ui-layout-center"></div>
            <div id="bottom" class="ui-layout-south">
                <span id="south-closer" class="pane-closer" title="#{msg['ws.common.icon.close']}" />
                <div id="bottomContent"></div>
            </div>
        </div>
        <div id="right" class="ui-layout-east">
            <span id="east-closer" class="pane-closer" title="#{msg['ws.common.icon.close']}" />
            <div id="rightContent"></div>
        </div>
    </div>

    <div id="footer">
        <ui:include src="/pages/common/footer.xhtml" />
    </div>

    <div id="loadingPanel" style="display: none">
        <img src="#{contextPath}/webresource/images/ajax-loader.gif" />
    </div>

    <div style="display: none">
        <a4j:status onstart="ws.ui.showLoader()" onstop="ws.ui.hideLoader()" />

        <iframe name="hidden" width="0" height="0" />

        <!-- Init RichFaces resources -->
        <rich:popupPanel id="initRfPopup" />
        <rich:calendar id="initRfCalendar" />
        <rich:inputNumberSpinner id="initRfSpinner" />
        <rich:dataTable id="initRfTable" />
        <oh:fileUpload id="initRfUpload" />
        <rich:tree id="initRfTree" />

        <h:form>
            <a4j:jsFunction name="onPageUnload" action="#{mainBean.onPageUnload}" onbegin="ws.ui.showLoader()" oncomplete="ws.ui.hideLoader()">
                <a4j:param name="requestId" assignTo="#{mainBean.requestId}" />
            </a4j:jsFunction>
            <a4j:jsFunction name="reloadModule" action="#{studio.compile}" onbegin="ws.ui.showLoader();" oncomplete="ws.nav.reload(true);ws.ui.hideLoader();" />
        </h:form>
    </div>

    <ui:include src="/pages/modules/tooLongDownload.xhtml"/>
    <ui:include src="/pages/modules/confirmPopup.xhtml" />
</h:body>
</html>
