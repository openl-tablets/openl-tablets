<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    template="/pages/layout/simpleLayout.xhtml"
    xmlns:a4j="http://richfaces.org/a4j">

    <ui:define name="content">
    <style>
      .installMessages ul {
        margin: 0;
        padding: 0;
        list-style-type: none;
      }
        select, input[type='text'], input[type='password'] {
            width: 20em;
        }

      #adBlock table tr td:first-child {
          min-width: 145px;
      }

    </style>

        <div class="wizard-page">
            <div class="wizard-page-container">
                <h:form id="step3Form">
                    <div class="wizard-block" id="usermodeBlock">
                        <h3>Select user mode:
                            <div class="field-description">
                                <p>User mode defines how many users can run the application and where user projects will be located by default.</p>
                                <p><strong>Single-user</strong> – Only the currently logged in user can run OpenL Tablets WebStudio. All user projects will be saved in the root of the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace' directory.</p>
                                <p><strong>Multi-user</strong> – Multiple users can run OpenL Tablets WebStudio using their unique user names.  The User’s projects will be located in the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace#{installWizard.folderSeparator}USERNAME' folder. User credentials are managed inside WebStudio.</p>
                                <p><strong>Active Directory</strong> – Multiple users can run OpenL Tablets WebStudio using their unique user names.  The User’s projects will be located in the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace#{installWizard.folderSeparator}USERNAME' folder. Active Directory will be used to authenticate and manage user credentials.</p>
                            </div>
                        </h3>
                        <div>
                            <h:selectOneRadio value="#{installWizard.userMode}" layout="pageDirection" >
                                <f:selectItem itemValue="single" itemLabel="Single-user" />
                                <f:selectItem itemValue="multi" itemLabel="Multi-user" />
                                <f:selectItem itemValue="ad" itemLabel="Active Directory" />
                            </h:selectOneRadio>
                        </div>
                    </div>
                    <div class="wizard-block" id="appmodeBlock">
                        <h3>Select application mode:
                            <div class="field-description">
                                <p>Here you should choose which Database to use for managing users in the application.</p>
                                <p><strong>Production</strong> – You will use an external database to manage OpenL Tablets WebStudio users.  The database allows you to add/remove users and change their access rights.</p>
                                <p><strong>Demo</strong> – You will use an internal User Database with predefined list of users. All changes in the database will be lost after the application restart.</p>
                            </div>
                        </h3>
                        <div>
                            <h:selectOneRadio value="#{installWizard.appMode}" layout="pageDirection" immediate="true">
                                <f:selectItem itemValue="production" itemLabel="Production" />
                                <f:selectItem itemValue="demo" itemLabel="Demo" />
                                <f:ajax  listener="#{installWizard.appmodeChanged}" />
                            </h:selectOneRadio>
                        </div>
                    </div>
                    <div class="wizard-block" id="dbBlock">
                        <h3>Configure database:
                            <div class="field-description">
                                <p>Set up a database to be used for managing users in OpenL Tablets WebStudio.<br />
                                   Please contact your System Administrator for this information if necessary.</p>
                            </div>
                        </h3>
                        <div>
                            <table>
                                
                                <tr>
                                    <td colspan="2">
                                        <a4j:outputPanel styleClass="installMessages" ajaxRendered="true">
                                            <h:messages infoClass="success" errorClass="error" showDetail="true"
                                                showSummary="false" tooltip="true" globalOnly="true" />
                                            <h:message  class="error" for="dbPassword" />
                                        </a4j:outputPanel>
                                    </td>
                                   </tr>
                                <tr>
                                    <td><label>Database type</label></td>
                                    <td>
                                        <h:selectOneMenu value="#{installWizard.dbVendor}" id="dbVendor" immediate="true">
                                            <f:selectItem itemValue="#{null}" itemLabel="Select one"/>
                                            <f:selectItems value="#{installWizard.DBVendors}" />
                                            <f:ajax  listener="#{installWizard.dbVendorChanged}" />
                                            <f:ajax render="dbUrl dbUsername"/>
                                        </h:selectOneMenu> 
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Database URL</label></td>
                                    <td>
                                        <h:inputText id="dbUrl" value="#{installWizard.dbUrl}" size="40" >
                                        <f:ajax  listener="#{installWizard.urlChanged}" />
                                        </h:inputText>
                                    </td>
                                </tr>
                                <tr><td></td></tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td><label>Login:</label></td>
                                        <td>
                                           <h:inputText id="dbUsername" value="#{installWizard.dbUsername}" size="40">
                                           <f:ajax  listener="#{installWizard.usernameChanged}" />
                                           </h:inputText>
                                         </td>
                                </tr>
                                <tr>
                                    <td><label>Password:</label></td>
                                    <td>
                                        <h:inputSecret id="dbPassword" value="#{installWizard.dbPassword}" size="40"
                                                       redisplay="true"
                                                       validator="#{installWizard.dbValidator}"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="wizard-block" id="adBlock">
                        <h3>Configure Active Directory:
                            <div class="field-description">
                                <p>Set up an Active Directory to use for managing users in OpenL Tablets WebStudio.<br />
                                   Please contact your System Administrator for this information if necessary.</p>
                            </div>
                        </h3>
                        <div>
                            <table>
                                <tr>
                                    <td colspan="2">
                                        <a4j:outputPanel styleClass="installMessages" ajaxRendered="true">
                                            <h:messages infoClass="success" errorClass="error" showDetail="true"
                                                showSummary="false" tooltip="true" globalOnly="true" />
                                            <h:message  class="error" for="adPassword" />
                                        </a4j:outputPanel>
                                        <span id="ad-successful-message" class="success" style="display:none">Connection successful</span>
                                    </td>
                                   </tr>
                                <tr>
                                    <td><label>Active Directory domain:</label></td>
                                    <td>
                                        <h:inputText id="adDomain" value="#{installWizard.adDomain}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Active Directory URL:</label></td>
                                    <td>
                                        <h:inputText id="adUrl" value="#{installWizard.adUrl}" size="40"/>
                                    </td>
                                </tr>
                            </table>

                            <div class="field-description">
                                <p>Username and Password are used to check connection to Active Directory. They will not be saved anywhere.</p>
                            </div>

                            <table>
                                <tr>
                                    <td><label>Username:</label></td>
                                    <td>
                                        <h:inputText id="adUsername" value="#{installWizard.adUsername}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Password:</label></td>
                                    <td>
                                        <h:inputSecret id="adPassword" value="#{installWizard.adPassword}" size="40" validator="#{installWizard.adValidator}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>
                                        <a4j:commandButton id="adConnectionCheck"
                                                           value="Check connection"
                                                           execute="adDomain adUrl adUsername adPassword"
                                                           oncomplete="toggleBlock('#ad-successful-message', #{!facesContext.validationFailed});"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="wizard-block" id="adAppmodeBlock">
                        <h3>Select application mode:
                            <div class="field-description">
                                <p>Here you should choose which Database to use for managing groups in the application.</p>
                                <p><strong>Production</strong> – You will use an external database to manage OpenL Tablets WebStudio groups.  The database allows you to add/remove groups and change their access rights.</p>
                                <p><strong>Demo</strong> – You will use an internal Groups Database with predefined list of groups. All changes in the database will be lost after the application restart.</p>
                            </div>
                        </h3>
                        <div>
                            <h:selectOneRadio value="#{installWizard.adAppMode}" layout="pageDirection" immediate="true">
                                <f:selectItem itemValue="production" itemLabel="Production" />
                                <f:selectItem itemValue="demo" itemLabel="Demo" />
                                <f:ajax  listener="#{installWizard.appmodeChanged}" />
                            </h:selectOneRadio>
                        </div>
                    </div>
                    <div class="wizard-block" id="adDbBlock">
                        <h3>Configure database:
                            <div class="field-description">
                                <p>Set up a database to be used for managing groups in OpenL Tablets WebStudio.<br />
                                    Please contact your System Administrator for this information if necessary.</p>
                            </div>
                        </h3>
                        <div>
                            <table>

                                <tr>
                                    <td colspan="2">
                                        <a4j:outputPanel styleClass="installMessages" ajaxRendered="true">
                                            <h:messages infoClass="success" errorClass="error" showDetail="true"
                                                        showSummary="false" tooltip="true" globalOnly="true" />
                                            <h:message  class="error" for="adDbPassword" />
                                        </a4j:outputPanel>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Database type</label></td>
                                    <td>
                                        <h:selectOneMenu value="#{installWizard.adDbVendor}" id="adDbVendor" immediate="true">
                                            <f:selectItem itemValue="#{null}" itemLabel="Select one"/>
                                            <f:selectItems value="#{installWizard.DBVendors}" />
                                            <f:ajax  listener="#{installWizard.dbVendorChanged}" />
                                            <f:ajax render="adDbUrl adDbUsername"/>
                                        </h:selectOneMenu>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Database URL</label></td>
                                    <td>
                                        <h:inputText id="adDbUrl" value="#{installWizard.dbUrl}" size="40" >
                                            <f:ajax  listener="#{installWizard.urlChanged}" />
                                        </h:inputText>
                                    </td>
                                </tr>
                                <tr><td></td></tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td><label>Username</label></td>
                                    <td>
                                        <h:inputText id="adDbUsername" value="#{installWizard.dbUsername}" size="40">
                                            <f:ajax  listener="#{installWizard.usernameChanged}" />
                                        </h:inputText>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Password</label></td>
                                    <td>
                                        <h:inputSecret id="adDbPassword" value="#{installWizard.dbPassword}" size="40"
                                                       redisplay="true"
                                                       validator="#{installWizard.dbValidator}"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="wizard-buttons" id="finish-buttons">
                        <h:commandButton id="prevButton" value="Prev" action="#{installWizard.prev}" onclick="showLoader()" immediate="true" />
                        <h:commandButton value="Finish" action="#{installWizard.finish}" class="button-primary" onclick="showLoader()" />
                        <span style="color:#7b1">Click 'Finish' to complete the installation process</span>
                    </div>
                    <div class="wizard-buttons" id="next-buttons">
                        <h:commandButton id="prevButtonAd" value="Prev" action="#{installWizard.prev}" onclick="showLoader()" immediate="true" />
                        <h:commandButton value="Next" action="#{installWizard.next}" class="button-primary" onclick="showLoader()" />
                    </div>
                </h:form>
            </div>
        </div>

        <script>
            //<![CDATA[

            // TODO Move to UI JS model
            function toggleBlock(selector, toggle) {
                $j(selector).toggle(toggle);
                $j(selector + " input")
                    .not("input[type='radio']")
                    .not("input[type='submit']")
                    .prop('disabled', !toggle);
            }

            (function() {
                var toggleVisibleBlocks = function () {
                    toggleBlock("#appmodeBlock", $j("#usermodeBlock input:checked").val() === "multi");
                    toggleBlock("#dbBlock", $j("#usermodeBlock input:checked").val() === "multi"
                        && $j("#appmodeBlock input:checked").val() !== "demo");
                    toggleBlock("#adBlock", $j("#usermodeBlock input:checked").val() === "ad");
                    toggleBlock("#adAppmodeBlock", $j("#usermodeBlock input:checked").val() === "ad");
                    toggleBlock("#adDbBlock", $j("#usermodeBlock input:checked").val() === "ad"
                        && $j("#adAppmodeBlock input:checked").val() !== "demo");
                    toggleBlock("#finish-buttons", $j("#usermodeBlock input:checked").val() !== "ad");
                    toggleBlock("#next-buttons", $j("#usermodeBlock input:checked").val() === "ad");
                };

                var updateCheckConnectionButton = function () {
                    var username = $j("#step3Form\\:adUsername").val();
                    var password = $j("#step3Form\\:adPassword").val();
                    // Disable the button if username and password are empty
                    var isBlank = !username || !password || /^\s*$/.test(username);
                    $j("#step3Form\\:adConnectionCheck").prop('disabled', isBlank);
                };

                toggleVisibleBlocks();
                updateCheckConnectionButton();

                $j("#usermodeBlock input").change(function(e) {
                    toggleVisibleBlocks();
                });

                $j("#appmodeBlock input").change(function(e) {
                    toggleBlock("#dbBlock", e.target.value !== "demo");
                });

                $j("#adAppmodeBlock input").change(function(e) {
                    toggleBlock("#adDbBlock", e.target.value !== "demo");
                });

                $j("#step3Form\\:adUsername").on("change keyup cut paste", function () {
                    updateCheckConnectionButton();
                });
                $j("#step3Form\\:adPassword").on("change keyup cut paste", function () {
                    updateCheckConnectionButton();
                });

            })();

            //]]>
        </script>

    </ui:define>
</ui:composition>
