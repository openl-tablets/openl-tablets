<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:c="http://java.sun.com/jstl/core"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:rules="http://openl-tablets.sourceforge.net/jsf"
    template="/facelets/common/studioBase.xhtml">

    <ui:define name="header">	 
        <script type="text/javascript">
            function open_win(url, name) {
                window.open(url, name, "toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=yes, width=900, height=700, top=20, left=100")
            }
        </script>
        <style>
            form {
                margin: 0px;
            }
            .editToolbar {
                border: 1px solid rgb(182,186,190);
            }
            .editToolbar a {
                margin-left: 5px;
            }
        </style>
    </ui:define>

    <ui:define name="page">
        <br/>
        
        <table class="editToolbar"><tr><td>
            <h:form>
                <h:outputLink rendered="#{showTableBean.editable}"
                    value="#{contextPath}/faces/facelets/tableeditor/showTable.xhtml">
                    <f:param name="uri" value="#{showTableBean.uri}" />
                    <f:param name="mode" value="edit" />
                    <f:param name="view" value="#{showTableBean.view}" />
                    <f:param name="showFormulas" value="#{showTableBean.showFormulas}" />
                    <h:graphicImage url="/webresource/images/editTable.gif" alt="Edit Table" title="Edit Table" />
                </h:outputLink>

                <h:commandLink rendered="#{showTableBean.editableAsNewVersion}"
                    action="#{tableCopierWizardManager.startWizard}">
                    <a4j:actionparam assignTo="#{tableCopierWizardManager.copyType}" value="CHANGE_VERSION" />
                    <f:param name="uri" value="#{showTableBean.uri}" />
                    <h:graphicImage url="/webresource/images/editTableNewVersion.gif"
                        alt="Edit Table as New Version" title="Edit Table as New Version" />
                </h:commandLink>

                <h:outputLink rendered="#{showTableBean.editable}"
                    value="#{contextPath}/jsp/showLinks.jsp?#{showTableBean.url}"
                    target="show_app_hidden">
                    <h:graphicImage
                        url="/webresource/images/excel-workbook.png"
                        title="Edit Table In Excel - #{showTableBean.uri}"
                        alt="Edit Table In Excel - #{showTableBean.uri}" />
                </h:outputLink>

                <h:outputLink rendered="#{showTableBean.copyable}"                    
                    value="#{contextPath}/faces/facelets/tableCopier/copyTableSelectOptions.xhtml">
                    <f:param name="uri" value="#{showTableBean.uri}" />
                    <h:graphicImage url="/webresource/images/copyTable.gif" alt="Copy Table" title="Copy Table" />
                </h:outputLink>

                <h:commandLink rendered="#{showTableBean.editable}"
                    action="#{showTableBean.removeTable}"
                    onclick="if(!confirm('Do you really want to remove this table?'))return false;">
                    <h:graphicImage url="/webresource/images/delete.gif" alt="Remove Table" title="Remove Table" />
                </h:commandLink>

                <c:if test="#{showTableBean.runnable and !showTableBean.hasErrors}">
                    <h:outputLink value="#{contextPath}/jsp/runMethod.jsp" title="Run">
                        <f:param value="#{showTableBean.uri}" name="uri" />
                        <h:graphicImage url="/webresource/images/test.gif" alt="test" />
                    </h:outputLink>

                    <c:set var="traceUrl"
                        value="#{contextPath}/treeview.jsp?title=Trace&amp;treejsp=faces/facelets/trace/tree.xhtml&amp;relwidth=70&amp;mainjsp=jsp/showTraceTable.jsp&amp;uri=#{showTableBean.encodedUri}&amp;first=true" />
                    <a onclick="open_win('#{traceUrl}', 'trace_win')" href="#" title="Trace">
                        <img border="0" src="webresource/images/trace.gif" alt="trace" /></a>

                    <h:outputLink
                        value="#{contextPath}/faces/facelets/studio/benchmarkMethod.xhtml" title="Benchmark">
                        <f:param value="#{showTableBean.uri}" name="uri" />
                        <h:graphicImage url="/webresource/images/clock-icon.png"
                            alt="benchmark" />
                    </h:outputLink>
                </c:if>

                <c:if
                    test="#{showTableBean.testable and !showTableBean.hasErrors}">
                    <h:outputLink value="#{contextPath}/jsp/runAllTests.jsp" title="Test">
                        <f:param value="#{showTableBean.uri}" name="uri" />
                        <h:graphicImage url="/webresource/images/test_ok.gif" alt="test" />
                    </h:outputLink>
                </c:if>

                <h:outputLink
                    value="?#{showTableBean.notViewParams}">
                    <f:param value="view.business" name="view" />
                    <h:graphicImage
                        url="/webresource/images/business-view.png"
                        title="Business View" alt="Business View" />
                </h:outputLink>

                <h:outputLink
                    value="?#{showTableBean.notViewParams}">
                    <f:param value="view.developer" name="view" />
                    <h:graphicImage
                        url="/webresource/images/developer-view.png"
                        title="Developer (Full) View"
                        alt="Full View" />
                </h:outputLink>

                <c:if test="#{showTableBean.showFormulas}">
                    <h:outputLink
                        value="?#{showTableBean.paramsWithoutShowFormulas}">
                        <f:param value="false" name="showFormulas" />
                        <h:graphicImage
                            url="/webresource/images/dont-show-formulas.png"
                            title="Don't Show Formulas"
                            alt="Don't Show Formulas" />
                    </h:outputLink>
                </c:if>

                <c:if test="#{not showTableBean.showFormulas}">
                    <h:outputLink
                        value="?#{showTableBean.paramsWithoutShowFormulas}">
                        <f:param value="true" name="showFormulas" />
                        <h:graphicImage
                            url="/webresource/images/show-formulas.png"
                            title="Show Formulas"
                            alt="Show Formulas" />
                    </h:outputLink>
                </c:if>

            </h:form>
        </td></tr></table>

        <h:panelGroup rendered="#{showTableBean.tsnHasErrors}" layout="block" style="margin-top: 10px;">
            <ui:include src="/WEB-INF/include/facelets/errorDisplay.xhtml" />
            <div style="font-weight: bold; font-size: 12px; margin: 0px 2px;">
                <span style="margin-right: 4px">Problems</span>
                <h:graphicImage url="/webresource/images/arrow_down.gif" title="Hide Errors"
                    onclick="$('errorsPanel').toggle();this.src=(this.title == 'Hide Errors' ? '#{contextPath}/images/arrow_right.gif' : '#{contextPath}/images/arrow_down.gif');this.title=(this.title == 'Hide Errors' ? 'Show Errors' : 'Hide Errors');" />
            </div>
            <div id="errorsPanel">
                <h:outputText value="#{showTableBean.errorString}" escape="false" />
                <br />
            </div>
        </h:panelGroup>

        <br />

        <script type="text/javascript">
            function triggerSearch(f) {
	           	f.searchQuery.value = $A($(PopupMenu.lastTarget).childNodes)
               	    .find(function(s) {
                        return s.nodeName == "#text"
                    }).nodeValue.sub(/^[.;,! \t\n()^&amp;*%=?\-'"+&lt;>]+/, "")
                      .split(/[.;,! \t\n()^&amp;*%=?\-'"+&lt;>]+/, 3)
                      .reject(function(s) {
                          return !s;
                      }).join(" ");
                f.submit();
            }

            function onBeforeSave() {
                $('saveWindow').component.show();
                window.parent.frames.leftFrame.document.getElementById('saveWindow').component.show();
            }

            function onAfterSave() {
                $('saveWindow').component.hide();
                window.parent.frames.leftFrame.document.getElementById('saveWindow').component.hide();
                resetTree();
            }

            function resetTree() {
                var treeHref = window.parent.frames.leftFrame.location.href;
                var nodeToOpenParam = treeHref.toQueryParams().nodeToOpen;
                if (nodeToOpenParam) {
                    treeHref = treeHref.replace(/\?nodeToOpen.*/ ,'');
                }
                treeHref += '?nodeToOpen=#{showTableBean.treeNodeId}';
                window.parent.frames.leftFrame.location.href = treeHref;
            }
        </script>

        <rich:modalPanel id="saveWindow" height="40" width="105" top="200" left="220"
            style="text-align:center; background:#fff; border-color:#B4C8FF; color:#323232">
            <h:panelGrid columns="2">
                <h:outputText value="Saving... " />
                <h:graphicImage url="/webresource/images/ajax-loader.gif" />
            </h:panelGrid>
        </rich:modalPanel>

        <form name="searchForm" method="post" action="#{contextPath}/jsp/search/search.jsp">
            <input type="hidden" name="searchQuery" value="" />
        </form>

        <rules:tableEditor table="#{showTableBean.table}" view="#{showTableBean.view}"
            mode="#{showTableBean.mode}" editable="#{showTableBean.editable}"
            showFormulas="#{showTableBean.showFormulas}" collapseProps="#{showTableBean.collapseProperties}"
            beforeSaveAction="#{showTableBean.updateSystemProperties}"
            afterSaveAction="#{showTableBean.afterSaveAction}" onBeforeSave="javascript:onBeforeSave();"
            onAfterSave="javascript:onAfterSave();" excludeScripts="prototype">
            <h:outputLink value="javascript:triggerSearch(document.forms.searchForm)">Search</h:outputLink>
        </rules:tableEditor>

        <c:set value="#{showTableBean.testRunResults}" var="testResult" />
        <c:if test="#{testResult.notEmpty}">
            <h1>
                Select one of the available runs by clicking on it:
            </h1>
            <c:forEach var="test" items="#{testResult.tests}">
                <c:forEach var="description"
                    items="#{test.descriptions}" varStatus="status">
                    <p>
                        <f:verbatim>&amp;nbsp;&amp;nbsp;</f:verbatim>
                        <h:outputLink value="#{contextPath}/jsp/runMethod.jsp" title="Run">
                            <f:param value="#{showTableBean.uri}" name="uri" />
                            <f:param value="#{test.testName}" name="testName" />
                            <f:param value="#{status.index}" name="testID" />
                            <f:param value="#{description}" name="testDescr" />
                            <h:graphicImage url="/webresource/images/test.gif" alt="test" />
                        </h:outputLink>
                        <f:verbatim>&amp;nbsp;</f:verbatim>
                        <h:outputLink
                            value="#{contextPath}/faces/facelets/studio/benchmarkMethod.xhtml"
                            title="Benchmark">
                            <f:param value="#{showTableBean.uri}" name="uri" />
                            <f:param value="#{test.testName}" name="testName" />
                            <f:param value="#{status.index}" name="testID" />
                            <f:param value="#{description}" name="testDescr" />
                            <h:graphicImage url="/webresource/images/clock-icon.png" alt="test" />
                        </h:outputLink>
                        <f:verbatim>&amp;nbsp;</f:verbatim>
                        <h:outputLink value="#{contextPath}/jsp/runMethod.jsp">
                            <f:param value="#{showTableBean.uri}" name="uri" />
                            <f:param value="#{test.testName}" name="testName" />
                            <f:param value="#{status.index}" name="testID" />
                            <f:param value="#{description}" name="testDescr" />
                            <h:outputText value="#{description}" />
                        </h:outputLink>
                    </p>
                </c:forEach>
            </c:forEach>
        </c:if>

    </ui:define>

</ui:composition>