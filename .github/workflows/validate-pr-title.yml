name: Validate PR Title

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title format
        id: validate_title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const labels = context.payload.pull_request.labels.map(l => l.name);

            // Skip validation for certain labels
            const skipLabels = ['bot', 'dependencies', 'skip-validation'];
            const hasSkipLabel = labels.some(label => skipLabels.includes(label));

            if (hasSkipLabel) {
              core.info('‚è≠Ô∏è  Skipping PR title validation due to label: ' + labels.join(', '));
              return true;
            }

            // Pattern 1: EPBDS-XXXX format (Jira)
            const jiraPattern = /^EPBDS-\d+\s+.+$/;

            // Pattern 2: Conventional Commits format
            const conventionalPattern = /^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|security)(\(DEV|STUDIO|WSFrontend|Util|ITEST|DEMO\))?:\s+.+$/;

            const isValid = jiraPattern.test(title) || conventionalPattern.test(title);

            if (!isValid) {
              core.setFailed('PR title does not match required format');
              return false;
            }

            core.info('‚úÖ PR title validation passed');
            return true;

      - name: Comment on PR (on failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Check if PR has skip labels
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const skipLabels = ['bot', 'dependencies', 'skip-validation'];
            const hasSkipLabel = pr.data.labels.some(label =>
              skipLabels.includes(label.name)
            );

            if (hasSkipLabel) {
              core.info('Skipping PR title validation due to label');
              return;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå PR Title Validation Failed

            Your PR title doesn't follow the required format.

            **Current title:** "${context.payload.pull_request.title}"

            ### Supported Formats:

            **1Ô∏è‚É£ Jira/EPBDS Format:**
            \`\`\`
            EPBDS-1234 Add dark mode toggle to settings
            EPBDS-5678 Fix memory leak in rule parser
            \`\`\`

            **2Ô∏è‚É£ Conventional Commits Format:**
            \`\`\`
            feat: add dark mode toggle
            feat(STUDIO): add dark mode toggle to settings
            fix(DEV): resolve memory leak in parser
            docs: update README with quick start
            \`\`\`

            **Valid types:** \`feat\`, \`fix\`, \`docs\`, \`style\`, \`refactor\`, \`perf\`, \`test\`, \`chore\`, \`ci\`, \`build\`, \`security\`

            **Valid scopes (optional):** \`DEV\`, \`STUDIO\`, \`WSFrontend\`, \`Util\`, \`ITEST\`, \`DEMO\`

            ---

            üí° **To skip validation:** Add the \`skip-validation\` label to this PR.`
            })
