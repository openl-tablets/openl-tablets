# Docker Compose for OpenL Tablets Development
# Provides local database infrastructure for development and testing
#
# Usage:
#   npm run infra:up      - Start all databases
#   npm run infra:down    - Stop all databases
#   npm run infra:logs    - View database logs

version: '3.8'

services:
  # PostgreSQL (Recommended for production)
  postgres:
    image: postgres:16
    container_name: openl-postgres-dev
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      POSTGRES_DB: openl
      POSTGRES_USER: openl
      POSTGRES_PASSWORD: openl
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openl"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - openl-dev
    restart: unless-stopped

  # MySQL (Alternative database)
  mysql:
    image: mysql:8.0
    container_name: openl-mysql-dev
    ports:
      - "127.0.0.1:3306:3306"
    environment:
      MYSQL_DATABASE: openl
      MYSQL_USER: openl
      MYSQL_PASSWORD: openl
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - openl-dev
    restart: unless-stopped

  # MariaDB (MySQL alternative)
  mariadb:
    image: mariadb:11.2
    container_name: openl-mariadb-dev
    ports:
      - "127.0.0.1:3307:3306"
    environment:
      MARIADB_DATABASE: openl
      MARIADB_USER: openl
      MARIADB_PASSWORD: openl
      MARIADB_ROOT_PASSWORD: rootpassword
    volumes:
      - mariadb-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - openl-dev
    restart: unless-stopped

  # Oracle Database Express Edition (Optional - large image)
  # Uncomment if you need Oracle for testing
  # oracle:
  #   image: container-registry.oracle.com/database/express:21.3.0-xe
  #   container_name: openl-oracle-dev
  #   ports:
  #     - "127.0.0.1:1521:1521"
  #   environment:
  #     ORACLE_PWD: oracle
  #     ORACLE_CHARACTERSET: AL32UTF8
  #   volumes:
  #     - oracle-data:/opt/oracle/oradata
  #   healthcheck:
  #     test: ["CMD-SHELL", "echo 'SELECT 1 FROM DUAL;' | sqlplus -s sys/oracle@localhost:1521/XE as sysdba"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #   networks:
  #     - openl-dev
  #   restart: unless-stopped

  # pgAdmin (PostgreSQL Web UI - Optional)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: openl-pgadmin-dev
    ports:
      - "127.0.0.1:5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@openl.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - openl-dev
    restart: unless-stopped
    profiles:
      - tools

  # Adminer (Universal Database UI - Optional)
  adminer:
    image: adminer:latest
    container_name: openl-adminer-dev
    ports:
      - "127.0.0.1:8082:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: dracula
    depends_on:
      - postgres
      - mysql
      - mariadb
    networks:
      - openl-dev
    restart: unless-stopped
    profiles:
      - tools

volumes:
  postgres-data:
    name: openl-postgres-data
  mysql-data:
    name: openl-mysql-data
  mariadb-data:
    name: openl-mariadb-data
  # oracle-data:
  #   name: openl-oracle-data
  pgadmin-data:
    name: openl-pgadmin-data

networks:
  openl-dev:
    name: openl-dev-network
    driver: bridge
