# OpenL Tablets - Multi-Container Deployment
# Separated components for small production or team development
#
# Components:
#   - OpenL Studio (port 8080)
#   - OpenL Rule Services (port 9090)
#   - PostgreSQL (port 5432)
#
# Usage:
#   docker-compose -f docker-compose-multi.yaml up -d
#
# Access:
#   OpenL Studio: http://localhost:8080
#   Rule Services: http://localhost:9090
#   Default credentials: admin / admin
#
# IMPORTANT: Change passwords before production use!

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: openl-postgres
    environment:
      - POSTGRES_DB=openl
      - POSTGRES_USER=openl
      - POSTGRES_PASSWORD=changeme
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openl"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - openl-backend

  # OpenL Studio
  studio:
    image: openltablets/studio:latest
    container_name: openl-studio
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      # Database Configuration
      - DATABASE_URL=postgresql://openl:changeme@postgres:5432/openl_studio
      - DATABASE_DRIVER=org.postgresql.Driver

      # Security Configuration
      - SECURITY_MODE=multi-user
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=admin

      # Workspace
      - STUDIO_WORKSPACE=/opt/openl/workspace

      # Java Options
      - JAVA_OPTS=-Xmx2g -Xms512m -XX:+UseG1GC

      # Logging
      - LOGGING_LEVEL=INFO

      # Repository Configuration
      - REPOSITORY_TYPE=git
      - REPOSITORY_PATH=/opt/openl/workspace/repositories

    volumes:
      # Workspace (projects, repositories, user data)
      - studio-workspace:/opt/openl/workspace

      # Logs
      - studio-logs:/opt/openl/logs

      # Custom configuration (optional)
      # - ./config/studio:/opt/openl/config:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    restart: unless-stopped
    networks:
      - openl-frontend
      - openl-backend

  # OpenL Rule Services
  ruleservices:
    image: openltablets/ruleservice:latest
    container_name: openl-ruleservices
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "9090:8080"
    environment:
      # Database Configuration
      - DATABASE_URL=postgresql://openl:changeme@postgres:5432/openl_ruleservices
      - DATABASE_DRIVER=org.postgresql.Driver

      # Deployment Configuration
      - RULESERVICE_DEPLOYMENT_PATH=/opt/openl/deployments
      - RULESERVICE_DATASOURCE_ENABLED=true

      # Java Options (Rule Services need more memory)
      - JAVA_OPTS=-Xmx4g -Xms1g -XX:+UseG1GC

      # Logging
      - LOGGING_LEVEL=INFO

      # API Configuration
      - RULESERVICE_API_ENABLED=true
      - RULESERVICE_OPENAPI_ENABLED=true
      - RULESERVICE_SWAGGER_ENABLED=true

      # Performance
      - RULESERVICE_CACHE_ENABLED=true

    volumes:
      # Deployments (rule artifacts)
      - ruleservices-deployments:/opt/openl/deployments

      # Logs
      - ruleservices-logs:/opt/openl/logs

      # Custom configuration (optional)
      # - ./config/ruleservices:/opt/openl/config:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    restart: unless-stopped
    networks:
      - openl-frontend
      - openl-backend

volumes:
  # PostgreSQL data
  postgres-data:
    driver: local

  # OpenL Studio volumes
  studio-workspace:
    driver: local

  studio-logs:
    driver: local

  # OpenL Rule Services volumes
  ruleservices-deployments:
    driver: local

  ruleservices-logs:
    driver: local

networks:
  # Frontend network (exposed services)
  openl-frontend:
    driver: bridge

  # Backend network (internal services)
  openl-backend:
    driver: bridge
    internal: false  # Set to true for complete isolation
